{% extends "base.html" %}

{% block title %}{{ course.name }} - StudyBuddy{% endblock %}

{% block content %}
<!-- Breadcrumb & Header -->
<div class="mb-6">
    <nav class="text-sm text-cozy-brown mb-2">
        <a href="{{ url_for('library.index') }}" class="hover:text-golden-yellow transition-colors">ğŸ“š ×”×¡×¤×¨×™×™×”</a>
        <span class="mx-2">/</span>
        <span class="text-dark-brown">{{ course.icon }} {{ course.name }}</span>
    </nav>
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
            <span class="text-4xl">{{ course.icon }}</span>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-dark-brown">{{ course.name }}</h1>
                {% if course.description %}
                <p class="text-cozy-brown text-sm mt-1">{{ course.description }}</p>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            <span class="px-3 py-1 bg-warm-beige text-cozy-brown text-sm rounded-full">
                {{ '×¢×‘×¨×™×ª' if course.language.value == 'he' else 'English' }}
            </span>
            <a href="{{ url_for('library.course_settings', course_id=course.id) }}" 
               class="px-3 py-1 border border-cozy-brown text-cozy-brown text-sm rounded-full hover:bg-cozy-brown hover:text-cream transition-colors">
                âš™ï¸ ×”×’×“×¨×•×ª
            </a>
        </div>
    </div>
</div>

{% if not has_content %}
<!-- Empty State - Upload First -->
<div class="bg-cream rounded-2xl p-8 shadow-md border-2 border-golden-yellow text-center">
    <img src="/avner/avner_looking_at_page_acratching_head.jpeg" 
         alt="××‘× ×¨ ××—×›×”" 
         class="w-24 h-24 rounded-full mx-auto mb-4 border-3 border-golden-yellow shadow-md">
    <h2 class="text-xl font-bold text-dark-brown mb-3">×”×§×•×¨×¡ ×¨×™×§! ğŸ“­</h2>
    <p class="text-cozy-brown mb-6 max-w-md mx-auto">
        ×›×“×™ ×œ×”×ª×—×™×œ ×œ×”×©×ª××© ×‘×›×œ×™×, ×§×•×“× ×¦×¨×™×š ×œ×”×¢×œ×•×ª ×—×•××¨×™ ×œ×™××•×“.<br>
        ××‘× ×¨ ×™×•×›×œ ×œ×¢×–×•×¨ ×œ×š ×¨×§ ××—×¨×™ ×©×™×›×™×¨ ××ª ×”×—×•××¨!
    </p>
    
    <!-- Upload Form -->
    <div class="bg-warm-beige rounded-xl p-6 max-w-lg mx-auto text-right">
        <h3 class="font-bold text-dark-brown mb-4">ğŸ“¤ ×”×¢×œ××ª ×—×•××¨ ×œ×™××•×“</h3>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="hidden" name="course_id" value="{{ course.id }}">
            
            <!-- Text Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×“×‘×§ ×˜×§×¡×˜:</label>
                <textarea name="text" rows="4" 
                    class="w-full p-3 border-2 border-warm-gray rounded-xl bg-white focus:border-golden-yellow focus:outline-none"
                    placeholder="×”×¢×ª×§ ×•×”×“×‘×§ ×›××Ÿ ×¡×™×›×•×, ×”×¢×¨×•×ª, ××• ×›×œ ×˜×§×¡×˜ ××”×§×•×¨×¡..."></textarea>
            </div>
            
            <!-- OR -->
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-1 border-t border-warm-gray"></div>
                <span class="text-cozy-brown text-sm">××•</span>
                <div class="flex-1 border-t border-warm-gray"></div>
            </div>
            
            <!-- File Upload -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×¢×œ×” ×§×•×‘×¥:</label>
                <input type="file" name="file" accept=".pdf,.doc,.docx,.txt,.pptx"
                    class="w-full p-3 border-2 border-dashed border-warm-gray rounded-xl bg-white">
                <p class="text-xs text-cozy-brown mt-1">PDF, Word, PowerPoint ××• ×˜×§×¡×˜ (×¢×“ 10MB)</p>
            </div>
            
            <button type="submit" 
                class="w-full bg-golden-yellow text-dark-brown font-bold py-3 px-6 rounded-xl hover:bg-warm-yellow transition-colors shadow-md">
                ğŸ“¤ ×”×¢×œ×” ×œ×§×•×¨×¡
            </button>
        </form>
    </div>
</div>

{% else %}
<!-- Course Has Content - Show Tools -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Main Content - Tools -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- Tools Grid -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Summary Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='summary') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸ“</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">××¡×›×</h3>
                <p class="text-xs text-cozy-brown mt-1">×¡×™×›×•× ×”×—×•××¨ ×œ× ×§×•×“×•×ª</p>
                {% if summaries|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ summaries|length }} ×¡×™×›×•××™×</span>
                {% endif %}
            </a>
            
            <!-- Flashcards Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='flashcards') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸƒ</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×›×¨×˜×™×¡×™×•×ª</h3>
                <p class="text-xs text-cozy-brown mt-1">×›×¨×˜×™×¡×™×•×ª ×œ×ª×¨×’×•×œ</p>
                {% if flashcard_sets|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ flashcard_sets|length }} ×¡×˜×™×</span>
                {% endif %}
            </a>
            
            <!-- Assess Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='assess') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">âœ…</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×‘×—×Ÿ ××•×ª×™</h3>
                <p class="text-xs text-cozy-brown mt-1">×©××œ×•×ª ×‘×—×™×¨×”</p>
                {% if assessments|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ assessments|length }} ××‘×—× ×™×</span>
                {% endif %}
            </a>
            
            <!-- Homework Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='homework') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸ“š</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×¢×–×¨×” ×‘×©×™×¢×•×¨×™×</h3>
                <p class="text-xs text-cozy-brown mt-1">×¢×–×¨×” ×‘×¤×ª×¨×•×Ÿ</p>
            </a>
        </div>
        
        <!-- Ask Avner about this course -->
        <div class="bg-cozy-brown rounded-xl p-5 flex items-center gap-4">
            <img src="/avner/avner_signing_ok.jpeg" alt="××‘× ×¨" class="w-14 h-14 rounded-full border-2 border-golden-yellow">
            <div class="flex-1">
                <h3 class="font-bold text-cream">×©××œ ××ª ××‘× ×¨ ×¢×œ ×”×§×•×¨×¡ ×”×–×”</h3>
                <p class="text-warm-yellow text-sm">××‘× ×¨ ××›×™×¨ ××ª ×›×œ ×”×—×•××¨ ×©×”×¢×œ×™×ª ×•×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª!</p>
            </div>
            <button onclick="askAboutCourse()" class="bg-golden-yellow text-dark-brown font-bold px-4 py-2 rounded-xl hover:bg-warm-yellow transition-colors">
                ×©××œ
            </button>
        </div>
    </div>
    
    <!-- Sidebar - Documents & Upload -->
    <div class="space-y-6">
        <!-- Upload More -->
        <div class="bg-cream rounded-xl p-5 shadow-md border border-warm-yellow">
            <h3 class="font-bold text-dark-brown mb-3">ğŸ“¤ ×”×•×¡×£ ×—×•××¨</h3>
            <form id="upload-more-form" enctype="multipart/form-data">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="file" name="file" accept=".pdf,.doc,.docx,.txt,.pptx"
                    class="w-full p-2 border border-dashed border-warm-gray rounded-lg bg-warm-beige text-sm mb-2">
                <button type="submit" class="w-full bg-golden-yellow text-dark-brown font-medium py-2 rounded-lg hover:bg-warm-yellow transition-colors text-sm">
                    ×”×¢×œ×”
                </button>
            </form>
        </div>
        
        <!-- Documents List -->
        <div class="bg-cream rounded-xl p-5 shadow-md border border-warm-yellow">
            <h3 class="font-bold text-dark-brown mb-3">ğŸ“„ ×”×—×•××¨×™× ×‘×§×•×¨×¡</h3>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                {% for doc in documents %}
                <div class="flex items-center justify-between p-2 bg-warm-beige rounded-lg text-sm">
                    <span class="truncate flex-1" title="{{ doc.filename }}">{{ doc.original_filename or doc.filename }}</span>
                    <span class="text-xs text-cozy-brown mr-2">{{ (doc.file_size / 1024)|round|int }}KB</span>
                </div>
                {% else %}
                <p class="text-cozy-brown text-sm">××™×Ÿ ××¡××›×™× ×¢×“×™×™×Ÿ</p>
                {% endfor %}
            </div>
            <p class="text-xs text-cozy-brown mt-3">{{ documents|length }} ××¡××›×™× ×‘×§×•×¨×¡</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Upload form handler
    document.getElementById('upload-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const res = await fetch('/api/upload/', {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                window.location.reload();
            } else {
                alert('×©×’×™××” ×‘×”×¢×œ××”. × ×¡×” ×©×•×‘.');
            }
        } catch (error) {
            alert('×©×’×™××” ×‘×”×¢×œ××”.');
        }
    });
    
    document.getElementById('upload-more-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const res = await fetch('/api/upload/', {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                window.location.reload();
            } else {
                alert('×©×’×™××” ×‘×”×¢×œ××”.');
            }
        } catch (error) {
            alert('×©×’×™××” ×‘×”×¢×œ××”.');
        }
    });
    
    function askAboutCourse() {
        // Open Avner chat with course context
        if (typeof toggleAvnerChat === 'function') {
            toggleAvnerChat();
        }
    }
</script>
{% endblock %}
