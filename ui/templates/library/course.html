{% extends "base.html" %}

{% block title %}{{ course.name }} - StudyBuddy{% endblock %}

{% block content %}
<!-- Breadcrumb & Header -->
<div class="mb-6">
    <nav class="text-sm text-cozy-brown mb-2">
        <a href="{{ url_for('library.index') }}" class="hover:text-golden-yellow transition-colors">ğŸ“š ×”×¡×¤×¨×™×™×”</a>
        <span class="mx-2">/</span>
        <span class="text-dark-brown">{{ course.icon }} {{ course.name }}</span>
    </nav>
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
            <span class="text-4xl">{{ course.icon }}</span>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-dark-brown">{{ course.name }}</h1>
                {% if course.description %}
                <p class="text-cozy-brown text-sm mt-1">{{ course.description }}</p>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            <span class="px-3 py-1 bg-warm-beige text-cozy-brown text-sm rounded-full">
                {{ '×¢×‘×¨×™×ª' if course.language.value == 'he' else 'English' }}
            </span>
            <a href="{{ url_for('library.course_settings', course_id=course.id) }}" 
               class="px-3 py-1 border border-cozy-brown text-cozy-brown text-sm rounded-full hover:bg-cozy-brown hover:text-cream transition-colors">
                âš™ï¸ ×”×’×“×¨×•×ª
            </a>
        </div>
    </div>
</div>

{% if not has_content %}
<!-- Empty State - Upload First -->
<div class="bg-cream rounded-2xl p-8 shadow-md border-2 border-golden-yellow text-center">
    <img src="/avner/avner_looking_at_page_acratching_head.jpeg" 
         alt="××‘× ×¨ ××—×›×”" 
         class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-golden-yellow shadow-md">
    <h2 class="text-2xl font-bold text-dark-brown mb-3">×”×§×•×¨×¡ ×¨×™×§! ğŸ“­</h2>
    <p class="text-cozy-brown mb-6 max-w-md mx-auto text-lg">
        ×›×“×™ ×œ×”×ª×—×™×œ ×œ×”×©×ª××© ×‘×›×œ×™× ×”×—×›××™×, ×§×•×“× ×¦×¨×™×š ×œ×”×¢×œ×•×ª ×—×•××¨×™ ×œ×™××•×“.<br>
        <strong>××‘× ×¨ ×™×•×›×œ ×œ×¢×–×•×¨ ×œ×š ×¨×§ ××—×¨×™ ×©×™×›×™×¨ ××ª ×”×—×•××¨!</strong>
    </p>
    
    <div class="bg-warm-yellow/30 rounded-xl p-4 max-w-md mx-auto mb-6">
        <p class="text-sm text-dark-brown font-medium">
            ğŸ’¡ <strong>×˜×™×¤:</strong> ×”×¢×œ×” ×¡×™×›×•××™×, ××¦×’×•×ª, ××• PDF ×©×œ ×”×—×•××¨ - ×›×›×œ ×©×™×•×ª×¨ ××™×“×¢, ×›×š ××‘× ×¨ ×™×•×›×œ ×œ×¢×–×•×¨ ×™×•×ª×¨!
        </p>
    </div>
    
    <!-- Upload Form -->
    <div class="bg-warm-beige rounded-xl p-6 max-w-lg mx-auto text-right">
        <h3 class="font-bold text-dark-brown mb-4">ğŸ“¤ ×”×¢×œ××ª ×—×•××¨ ×œ×™××•×“</h3>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="hidden" name="course_id" value="{{ course.id }}">
            
            <!-- Text Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×“×‘×§ ×˜×§×¡×˜:</label>
                <textarea name="text" rows="4" 
                    class="w-full p-3 border-2 border-warm-gray rounded-xl bg-white focus:border-golden-yellow focus:outline-none"
                    placeholder="×”×¢×ª×§ ×•×”×“×‘×§ ×›××Ÿ ×¡×™×›×•×, ×”×¢×¨×•×ª, ××• ×›×œ ×˜×§×¡×˜ ××”×§×•×¨×¡..."></textarea>
            </div>
            
            <!-- OR -->
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-1 border-t border-warm-gray"></div>
                <span class="text-cozy-brown text-sm">××•</span>
                <div class="flex-1 border-t border-warm-gray"></div>
            </div>
            
            <!-- File Upload -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×¢×œ×” ×§×•×‘×¥:</label>
                <input type="file" name="file" accept=".pdf,.docx,.pptx,.txt,.html,.png,.jpg,.jpeg,.gif"
                    class="w-full p-3 border-2 border-dashed border-warm-gray rounded-xl bg-white">
                <p class="text-xs text-cozy-brown mt-1">PDF, Word (DOCX), PowerPoint, HTML, ×ª××•× ×•×ª ××• ×˜×§×¡×˜ (×¢×“ 50MB)</p>
            </div>
            
            <!-- Upload Status with Avner Animation -->
            <div id="upload-status" class="hidden mb-4 text-center">
                <img id="upload-avner-img" src="/avner/loading.jpeg" 
                     alt="××‘× ×¨ ××¢×œ×”" 
                     class="w-20 h-20 rounded-full mx-auto mb-2 border-2 border-golden-yellow shadow-md animate-pulse">
                <p id="upload-status-text" class="text-sm font-medium text-cozy-brown"></p>
            </div>
            
            <button type="submit" id="upload-submit-btn"
                class="w-full bg-golden-yellow text-dark-brown font-bold py-3 px-6 rounded-xl hover:bg-warm-yellow transition-colors shadow-md">
                ğŸ“¤ ×”×¢×œ×” ×œ×§×•×¨×¡
            </button>
        </form>
    </div>
</div>

{% else %}
<!-- Course Has Content - Show Tools -->
<div class="mb-6 bg-success/10 border-2 border-success rounded-xl p-4">
    <div class="flex items-center gap-3">
        <img src="/avner/avner_celebrating.jpeg" alt="××‘× ×¨ ×©××—" class="w-12 h-12 rounded-full border-2 border-success">
        <div>
            <h3 class="font-bold text-dark-brown text-lg">âœ… ×”×›×œ ××•×›×Ÿ!</h3>
            <p class="text-cozy-brown text-sm">{{ documents|length }} ××¡××›×™× ×‘×§×•×¨×¡ - ×›×œ ×”×›×œ×™× ×–××™× ×™× ×œ×©×™××•×©</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Main Content - Tools -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- Tools Grid -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Summary Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='summary') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸ“</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">××¡×›×</h3>
                <p class="text-xs text-cozy-brown mt-1">×¡×™×›×•× ×”×—×•××¨ ×œ× ×§×•×“×•×ª</p>
                {% if summaries|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ summaries|length }} ×¡×™×›×•××™×</span>
                {% endif %}
            </a>
            
            <!-- Flashcards Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='flashcards') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸƒ</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×›×¨×˜×™×¡×™×•×ª</h3>
                <p class="text-xs text-cozy-brown mt-1">×›×¨×˜×™×¡×™×•×ª ×œ×ª×¨×’×•×œ</p>
                {% if flashcard_sets|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ flashcard_sets|length }} ×¡×˜×™×</span>
                {% endif %}
            </a>
            
            <!-- Assess Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='assess') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">âœ…</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×‘×—×Ÿ ××•×ª×™</h3>
                <p class="text-xs text-cozy-brown mt-1">×©××œ×•×ª ×‘×—×™×¨×”</p>
                {% if assessments|length > 0 %}
                <span class="inline-block mt-2 px-2 py-1 bg-success/20 text-success text-xs rounded-full">{{ assessments|length }} ××‘×—× ×™×</span>
                {% endif %}
            </a>
            
            <!-- Homework Tool -->
            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='homework') }}" 
               class="bg-cream rounded-xl p-5 shadow-md border-2 border-warm-yellow hover:border-golden-yellow hover:shadow-lg transition-all group">
                <div class="text-3xl mb-2">ğŸ“š</div>
                <h3 class="font-bold text-dark-brown group-hover:text-cozy-brown">×¢×–×¨×” ×‘×©×™×¢×•×¨×™×</h3>
                <p class="text-xs text-cozy-brown mt-1">×¢×–×¨×” ×‘×¤×ª×¨×•×Ÿ</p>
            </a>
        </div>
        
        <!-- Ask Avner about this course -->
        <div class="bg-cozy-brown rounded-xl p-5 flex items-center gap-4">
            <img src="/avner/avner_signing_ok.jpeg" alt="××‘× ×¨" class="w-14 h-14 rounded-full border-2 border-golden-yellow">
            <div class="flex-1">
                <h3 class="font-bold text-cream">×©××œ ××ª ××‘× ×¨ ×¢×œ ×”×§×•×¨×¡ ×”×–×”</h3>
                <p class="text-warm-yellow text-sm">××‘× ×¨ ××›×™×¨ ××ª ×›×œ ×”×—×•××¨ ×©×”×¢×œ×™×ª ×•×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª!</p>
            </div>
            <button onclick="askAboutCourse()" class="bg-golden-yellow text-dark-brown font-bold px-4 py-2 rounded-xl hover:bg-warm-yellow transition-colors">
                ×©××œ
            </button>
        </div>
    </div>
    
    <!-- Sidebar - Documents & Upload -->
    <div class="space-y-6">
        <!-- Upload More -->
        <div class="bg-cream rounded-xl p-5 shadow-md border border-warm-yellow">
            <h3 class="font-bold text-dark-brown mb-3">ğŸ“¤ ×”×•×¡×£ ×—×•××¨</h3>
            <form id="upload-more-form" enctype="multipart/form-data">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="file" name="file" accept=".pdf,.doc,.docx,.txt,.pptx"
                    class="w-full p-2 border border-dashed border-warm-gray rounded-lg bg-warm-beige text-sm mb-2">
                <button type="submit" class="w-full bg-golden-yellow text-dark-brown font-medium py-2 rounded-lg hover:bg-warm-yellow transition-colors text-sm">
                    ×”×¢×œ×”
                </button>
            </form>
        </div>
        
        <!-- Documents List -->
        <div class="bg-cream rounded-xl p-5 shadow-md border border-warm-yellow">
            <h3 class="font-bold text-dark-brown mb-3">ğŸ“„ ×”×—×•××¨×™× ×‘×§×•×¨×¡</h3>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                {% for doc in documents %}
                <div class="flex items-center justify-between p-2 bg-warm-beige rounded-lg text-sm">
                    <span class="truncate flex-1" title="{{ doc.filename }}">{{ doc.original_filename or doc.filename }}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-cozy-brown">{{ (doc.file_size / 1024)|round|int }}KB</span>
                        <button onclick="deleteDocument('{{ doc._id }}')" 
                                class="text-red-600 hover:text-red-800 text-xs px-2 py-1 rounded hover:bg-red-100"
                                title="××—×§ ××¡××š">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
                {% else %}
                <p class="text-cozy-brown text-sm">××™×Ÿ ××¡××›×™× ×¢×“×™×™×Ÿ</p>
                {% endfor %}
            </div>
            <p class="text-xs text-cozy-brown mt-3">{{ documents|length }} ××¡××›×™× ×‘×§×•×¨×¡</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Upload form handler
    document.getElementById('upload-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = document.getElementById('upload-submit-btn');
        const originalText = submitBtn.innerHTML;
        const statusDiv = document.getElementById('upload-status');
        const statusText = document.getElementById('upload-status-text');
        const avnerImg = document.getElementById('upload-avner-img');
        
        // Check if user provided either text or file
        const textInput = formData.get('text');
        const fileInput = formData.get('file');
        
        if ((!textInput || textInput.trim() === '') && (!fileInput || fileInput.size === 0)) {
            alert('×™×© ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ××• ×œ×‘×—×•×¨ ×§×•×‘×¥ ×œ×”×¢×œ××”');
            return;
        }
        
        // Show Avner loading animation
        statusDiv.classList.remove('hidden');
        avnerImg.src = '/avner/loading.jpeg';
        avnerImg.classList.add('animate-pulse');
        statusText.textContent = '××¢×œ×” ××ª ×”×§×•×‘×¥...';
        
        // Disable button
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-75');
        
        try {
            const res = await fetch('/api/upload/', {
                method: 'POST',
                body: formData
            });
            
            const data = await res.json();
            
            if (res.ok) {
                // Check if file is being processed in background
                if (data.status === 'processing') {
                    avnerImg.src = '/avner/progress.jpeg';
                    statusText.textContent = '×”×§×•×‘×¥ ×”×•×¢×œ×”! ××‘× ×¨ ××¢×‘×“ ××ª ×”×ª×•×›×Ÿ...';
                    // Poll for completion
                    await pollDocumentStatus(data.document_id, avnerImg, statusText);
                } else {
                    // Text input - completed immediately
                    avnerImg.src = '/avner/avner_celebrating.jpeg';
                    avnerImg.classList.remove('animate-pulse');
                    statusText.textContent = 'âœ… ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!';
                    setTimeout(() => window.location.reload(), 800);
                }
            } else {
                statusDiv.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75');
                alert('×©×’×™××”: ' + (data.error || '× ×¡×” ×©×•×‘'));
            }
        } catch (error) {
            statusDiv.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-75');
            alert('×©×’×™××” ×‘×”×¢×œ××”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
            console.error('Upload error:', error);
        }
    });
    
    document.getElementById('upload-more-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        const fileInput = formData.get('file');
        
        if (!fileInput || fileInput.size === 0) {
            alert('×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×œ×”×¢×œ××”');
            return;
        }
        
        // Disable button and show loading with Avner
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<img src="/avner/loading.jpeg" class="w-6 h-6 inline-block animate-pulse"> ××¢×œ×”...';
        
        try {
            const res = await fetch('/api/upload/', {
                method: 'POST',
                body: formData
            });
            
            const data = await res.json();
            
            if (res.ok) {
                // Check if file is being processed in background
                if (data.status === 'processing') {
                    submitBtn.innerHTML = '<img src="/avner/progress.jpeg" class="w-6 h-6 inline-block animate-pulse"> ××¢×‘×“...';
                    // Poll for completion - simple version without status elements
                    await pollDocumentStatusSimple(data.document_id, submitBtn, originalText);
                } else {
                    // Text input - completed immediately
                    submitBtn.innerHTML = 'âœ… ×”×•×¢×œ×”!';
                    setTimeout(() => window.location.reload(), 500);
                }
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('×©×’×™××”: ' + (data.error || '× ×¡×” ×©×•×‘'));
            }
        } catch (error) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            alert('×©×’×™××” ×‘×”×¢×œ××”. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
            console.error('Upload error:', error);
        }
    });
    
    // Poll for document processing status with Avner animation
    async function pollDocumentStatus(documentId, avnerImg, statusText) {
        const maxAttempts = 60; // 60 seconds max
        let attempts = 0;
        
        const checkStatus = async () => {
            try {
                const res = await fetch(`/api/upload/status/${documentId}`);
                const data = await res.json();
                
                if (data.ready) {
                    avnerImg.src = '/avner/avner_celebrating.jpeg';
                    avnerImg.classList.remove('animate-pulse');
                    statusText.textContent = 'âœ… ×”×§×•×‘×¥ ××•×›×Ÿ! ×˜×•×¢×Ÿ ××—×“×©...';
                    setTimeout(() => window.location.reload(), 800);
                    return true;
                }
                
                // Still processing
                attempts++;
                if (attempts >= maxAttempts) {
                    avnerImg.src = '/avner/avner_thinking.jpeg';
                    avnerImg.classList.remove('animate-pulse');
                    statusText.textContent = 'â±ï¸ ×”×¢×™×‘×•×“ ×œ×•×§×— ×–××Ÿ... ×˜×•×¢×Ÿ ××—×“×©.';
                    setTimeout(() => window.location.reload(), 2000);
                    return true;
                }
                
                // Update status text with dots animation
                const dots = '.'.repeat((attempts % 3) + 1);
                statusText.textContent = `××‘× ×¨ ××¢×‘×“ ××ª ×”×§×•×‘×¥${dots}`;
                
                // Continue polling
                setTimeout(checkStatus, 1000);
                return false;
                
            } catch (error) {
                console.error('Status check error:', error);
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 1000);
                } else {
                    avnerImg.src = '/avner/avner_shy.jpeg';
                    avnerImg.classList.remove('animate-pulse');
                    statusText.textContent = 'â±ï¸ ××¢×‘×“ ×‘×¨×§×¢... ×˜×•×¢×Ÿ ××—×“×©.';
                    setTimeout(() => window.location.reload(), 2000);
                }
            }
        };
        
        await checkStatus();
    }
    
    // Simple polling for secondary upload forms
    async function pollDocumentStatusSimple(documentId, submitBtn, originalText) {
        const maxAttempts = 60;
        let attempts = 0;
        
        const checkStatus = async () => {
            try {
                const res = await fetch(`/api/upload/status/${documentId}`);
                const data = await res.json();
                
                if (data.ready) {
                    submitBtn.innerHTML = '<img src="/avner/avner_celebrating.jpeg" class="w-6 h-6 inline-block"> ×”×•×¢×œ×”!';
                    setTimeout(() => window.location.reload(), 500);
                    return true;
                }
                
                attempts++;
                if (attempts >= maxAttempts) {
                    submitBtn.innerHTML = 'â±ï¸ ××¢×‘×“ ×‘×¨×§×¢...';
                    setTimeout(() => window.location.reload(), 2000);
                    return true;
                }
                
                setTimeout(checkStatus, 1000);
                return false;
                
            } catch (error) {
                console.error('Status check error:', error);
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 1000);
                } else {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    alert('×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡. ×”×§×•×‘×¥ ×¢×“×™×™×Ÿ ××¢×•×‘×“ ×‘×¨×§×¢.');
                }
            }
        };
        
        await checkStatus();
    }
    
    function askAboutCourse() {
        // Open Avner chat with course context
        if (typeof toggleAvnerChat === 'function') {
            toggleAvnerChat();
        }
    }
    
    // Delete document function
    async function deleteDocument(docId) {
        if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××¡××š? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.')) {
            return;
        }
        
        try {
            const res = await fetch(`/api/upload/files/${docId}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                alert('×”××¡××š × ××—×§ ×‘×”×¦×œ×—×”!');
                window.location.reload();
            } else {
                const data = await res.json();
                alert('×©×’×™××” ×‘××—×™×§×ª ×”××¡××š: ' + (data.error || '× ×¡×” ×©×•×‘'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('×©×’×™××” ×‘××—×™×§×ª ×”××¡××š. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
        }
    }
</script>
{% endblock %}
