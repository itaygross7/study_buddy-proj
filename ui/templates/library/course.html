{% extends "base.html" %}

{% block title %}{{ course.name }} - StudyBuddy{% endblock %}

{% block content %}
<!-- Breadcrumb & Header -->
<div class="mb-6">
    <nav class="text-sm text-cozy-brown mb-2">
        <a href="{{ url_for('library.index') }}" class="hover:text-golden-yellow transition-colors">ğŸ“š ×”×¡×¤×¨×™×™×”</a>
        <span class="mx-2">/</span>
        <span class="text-dark-brown">{{ course.icon }} {{ course.name }}</span>
    </nav>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
            <span class="text-4xl">{{ course.icon }}</span>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-dark-brown">{{ course.name }}</h1>
                {% if course.description %}
                <p class="text-cozy-brown text-sm mt-1">{{ course.description }}</p>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            <span class="px-3 py-1 bg-warm-beige text-cozy-brown text-sm rounded-full">
                {{ '×¢×‘×¨×™×ª' if course.language.value == 'he' else 'English' }}
            </span>
            {# TASKS BUTTON REMOVED FROM DASHBOARD NAV #}
            <a href="{{ url_for('library.course_settings', course_id=course.id) }}"
               class="px-3 py-1 border border-cozy-brown text-cozy-brown text-sm rounded-full hover:bg-cozy-brown hover:text-cream transition-colors">
                âš™ï¸ ×”×’×“×¨×•×ª
            </a>
        </div>
    </div>
</div>

{% if not has_content %}
{# ===================== EMPTY COURSE STATE (UNCHANGED, GOOD) ===================== #}
<div class="bg-cream rounded-2xl p-8 shadow-md border-2 border-golden-yellow text-center">
    <img src="{{ url_for('serve_avner', filename='avner_looking_at_page_acratching_head.jpeg') }}"
         alt="××‘× ×¨ ××—×›×”"
         class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-golden-yellow shadow-md">
    <h2 class="text-2xl font-bold text-dark-brown mb-3">×”×§×•×¨×¡ ×¨×™×§! ğŸ“­</h2>
    <p class="text-cozy-brown mb-6 max-w-md mx-auto text-lg">
        ×›×“×™ ×œ×”×ª×—×™×œ ×œ×”×©×ª××© ×‘×›×œ×™× ×”×—×›××™×, ×§×•×“× ×¦×¨×™×š ×œ×”×¢×œ×•×ª ×—×•××¨×™ ×œ×™××•×“.<br>
        <strong>××‘× ×¨ ×™×•×›×œ ×œ×¢×–×•×¨ ×œ×š ×¨×§ ××—×¨×™ ×©×™×›×™×¨ ××ª ×”×—×•××¨!</strong>
    </p>

    <div class="bg-warm-yellow/30 rounded-xl p-4 max-w-md mx-auto mb-6">
        <p class="text-sm text-dark-brown font-medium">
            ğŸ’¡ <strong>×˜×™×¤:</strong> ×”×¢×œ×” ×¡×™×›×•××™×, ××¦×’×•×ª, ××• PDF ×©×œ ×”×—×•××¨ - ×›×›×œ ×©×™×•×ª×¨ ××™×“×¢, ×›×š ××‘× ×¨ ×™×•×›×œ ×œ×¢×–×•×¨ ×™×•×ª×¨!
        </p>
    </div>

    <!-- Upload Form -->
    <div class="bg-warm-beige rounded-xl p-6 max-w-lg mx-auto text-right">
        <h3 class="font-bold text-dark-brown mb-4">ğŸ“¤ ×”×¢×œ××ª ×—×•××¨ ×œ×™××•×“</h3>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="hidden" name="course_id" value="{{ course.id }}">

            <!-- Text Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×“×‘×§ ×˜×§×¡×˜:</label>
                <textarea name="text" rows="4"
                    class="w-full p-3 border-2 border-warm-gray rounded-xl bg-white focus:border-golden-yellow focus:outline-none mobile-scroll"
                    style="font-size: 16px;"
                    placeholder="×”×¢×ª×§ ×•×”×“×‘×§ ×›××Ÿ ×¡×™×›×•×, ×”×¢×¨×•×ª, ××• ×›×œ ×˜×§×¡×˜ ××”×§×•×¨×¡..."></textarea>
            </div>

            <!-- OR -->
            <div class="flex items-center gap-3 mb-4">
                <div class="flex-1 border-t border-warm-gray"></div>
                <span class="text-cozy-brown text-sm">××•</span>
                <div class="flex-1 border-t border-warm-gray"></div>
            </div>

            <!-- File Upload -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-brown mb-2">×”×¢×œ×” ×§×‘×¦×™× (××—×“ ××• ×™×•×ª×¨):</label>
                <div class="relative">
                    <input type="file" name="files" id="file-input-main" accept=".pdf,.docx,.pptx,.txt,.html,.png,.jpg,.jpeg,.gif"
                        multiple
                        style="font-size: 16px;"
                        class="w-full p-3 border-2 border-dashed border-warm-gray rounded-xl bg-white text-sm
                               file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold
                               file:bg-golden-yellow file:text-dark-brown hover:file:bg-warm-yellow
                               mobile-touch-target cursor-pointer
                               focus:outline-none focus:border-golden-yellow focus:ring-2 focus:ring-golden-yellow">
                    <p class="text-xs text-cozy-brown mt-1">
                        PDF, Word (.docx), PowerPoint (.pptx), HTML, ×ª××•× ×•×ª ××• ×˜×§×¡×˜ (×¢×“ 50MB ×œ×§×•×‘×¥) - × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×§×‘×¦×™× ××¨×•×‘×™×
                    </p>
                </div>
            </div>

            <!-- Upload Status with Avner Animation -->
            <div id="upload-status" class="hidden mb-4 text-center">
                <img id="upload-avner-img" src="{{ url_for('serve_avner', filename='loading.jpeg') }}"
                     alt="××‘× ×¨ ××¢×œ×”"
                     class="w-20 h-20 rounded-full mx-auto mb-2 border-2 border-golden-yellow shadow-md animate-pulse">
                <p id="upload-status-text" class="text-sm font-medium text-cozy-brown"></p>
            </div>

            <button type="submit" id="upload-submit-btn"
                class="w-full bg-golden-yellow text-dark-brown font-bold py-3 px-6 rounded-xl hover:bg-warm-yellow transition-colors shadow-md">
                ğŸ“¤ ×”×¢×œ×” ×œ×§×•×¨×¡
            </button>
        </form>
    </div>
</div>

{% else %}
{# ===================== COURSE HAS CONTENT ===================== #}

<!-- READY BANNER -->
<div class="mb-4 bg-success/10 border-2 border-success rounded-xl p-4">
    <div class="flex items-center gap-3">
        <img src="{{ url_for('serve_avner', filename='avner_celebrating.jpeg') }}" alt="××‘× ×¨ ×©××—" class="w-12 h-12 rounded-full border-2 border-success">
        <div>
            <h3 class="font-bold text-dark-brown text-lg">âœ… ×”×›×œ ××•×›×Ÿ!</h3>
            <p class="text-cozy-brown text-sm">
                {{ documents|length }} ××¡××›×™× ×‘×§×•×¨×¡
                {% if processing_tasks_count and processing_tasks_count > 0 %}
                    Â· ×—×œ×§ ××”×§×‘×¦×™× ×¢×“×™×™×Ÿ ×‘×¢×™×‘×•×“ ×‘×¨×§×¢
                {% else %}
                    Â· ×›×œ ×”×§×‘×¦×™× ××•×›× ×™× ×œ×©×™××•×© ×‘×›×œ×™×
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- 1) TOOLS DASHBOARD (TOP) -->
<section class="mb-6 bg-cream border border-cozy-brown/20 rounded-2xl px-4 py-4 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
        <h2 class="text-lg font-semibold text-dark-brown flex items-center gap-2">
            ğŸ§° ×›×œ×™ ×”×§×•×¨×¡
        </h2>
        <p class="text-xs text-cozy-brown">
            ×›×œ ×”×›×œ×™× ×¢×•×‘×“×™× ×¢×œ ×”×—×•××¨ ×©×”×¢×œ×™×ª ×œ×§×•×¨×¡ ×”×–×”
        </p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
        {% for tool in course_tools %}
        <a href="{{ url_for('library.course_tool', course_id=course.id, tool=tool.key) }}"
           class="group flex flex-col justify-between bg-cream-light border border-cream-dark/50 rounded-xl px-3 py-3
                  hover:border-cozy-brown hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xl">{{ tool.icon }}</span>

                {# STATUS BADGE #}
                {% if tool.status == 'ready' %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 text-[11px] px-2 py-0.5">
                        ××•×›×Ÿ
                    </span>
                {% elif tool.status == 'processing' %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-800 text-[11px] px-2 py-0.5">
                        ×‘×¢×™×‘×•×“...
                    </span>
                {% else %}
                    <span class="inline-flex items-center rounded-full bg-slate-100 text-slate-600 text-[11px] px-2 py-0.5">
                        ×××ª×™×Ÿ ×œ×—×•××¨
                    </span>
                {% endif %}
            </div>

            <div class="space-y-1">
                <p class="text-sm font-semibold text-dark-brown group-hover:text-cozy-brown">
                    {{ tool.name }}
                </p>
                {% if tool.description %}
                <p class="text-xs text-cozy-brown leading-snug">
                    {{ tool.description }}
                </p>
                {% endif %}

                {% if tool.key == 'summary' and summaries|length > 0 %}
                    <p class="text-[11px] text-success mt-1">
                        {{ summaries|length }} ×¡×™×›×•××™× ×§×™×™××™×
                    </p>
                {% elif tool.key == 'flashcards' and flashcard_sets|length > 0 %}
                    <p class="text-[11px] text-success mt-1">
                        {{ flashcard_sets|length }} ×¡×˜×™× ××•×›× ×™×
                    </p>
                {% elif tool.key == 'assess' and assessments|length > 0 %}
                    <p class="text-[11px] text-success mt-1">
                        {{ assessments|length }} ×‘×—× ×™× ×©×•××¨×™× ×ª×•×¦××•×ª
                    </p>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
</section>

<!-- 2) ASK AVNER CTA -->
<section class="mb-6 bg-capy-brown text-golden-yellow rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
    <div>
        <h3 class="text-lg font-bold text-golden-yellow">
            ×©××œ ××ª ××‘× ×¨ ×¢×œ ×”×§×•×¨×¡ ×”×–×”
        </h3>
        <p class="text-warm-yellow text-sm">
            ××‘× ×¨ ××›×™×¨ ××ª ×›×œ ×”×—×•××¨ ×©×”×¢×œ×™×ª ×•×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª, ×œ×”×¡×‘×™×¨ ×•×œ×—×–×•×¨ ××™×ª×š ×¢×œ ×”× ×•×©××™× ×”×—×©×•×‘×™×.
        </p>
    </div>
    <a href="{{ url_for('library.course_tool', course_id=course.id, tool='tutor') }}"
       class="bg-golden-yellow text-dark-brown font-bold px-4 py-2 rounded-xl hover:bg-warm-yellow transition-colors">
        ×©××œ
    </a>
</section>

<!-- 3) DOCUMENTS + UPLOAD PANEL (BOTTOM) -->
<section class="bg-cream border border-cozy-brown/20 rounded-2xl px-4 py-4 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div>
            <h2 class="text-lg font-semibold text-dark-brown flex items-center gap-2">
                ğŸ“š ×”××¡××›×™× ×‘×§×•×¨×¡
            </h2>
            <p class="text-xs text-cozy-brown mt-1">
                ×œ×—×¥ ×¢×œ ××¡××š ×›×“×™ ×œ×¨××•×ª ×ª×§×¦×™×¨ ×§×¦×¨ ×•× ×•×©××™× â€“ ×›×œ×™ ×”-AI ××©×ª××©×™× ×‘×–×” ×œ×›×œ ×”×¡×™×›×•××™×, ×”×›×¨×˜×™×¡×™×•×ª ×•×”×‘×—× ×™×.
            </p>
        </div>

        <!-- Upload more files -->
        <div class="bg-warm-beige rounded-xl p-3 border border-warm-yellow">
            <h3 class="text-sm font-bold text-dark-brown mb-2">ğŸ“¤ ×”×•×¡×£ ×—×•××¨</h3>
            <form id="upload-more-form" enctype="multipart/form-data" class="flex flex-col gap-2">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="file"
                       name="files"
                       id="file-input-more"
                       accept=".pdf,.docx,.pptx,.txt,.html,.png,.jpg,.jpeg,.gif"
                       multiple
                       style="font-size: 16px;"
                       class="w-full p-2 border border-dashed border-warm-gray rounded-lg bg-white text-xs
                              file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold
                              file:bg-golden-yellow file:text-dark-brown hover:file:bg-warm-yellow
                              mobile-touch-target cursor-pointer
                              focus:outline-none focus:border-golden-yellow focus:ring-2 focus:ring-golden-yellow">
                <button type="submit"
                        class="w-full bg-golden-yellow text-dark-brown font-medium py-2 rounded-lg hover:bg-warm-yellow transition-colors text-xs mobile-touch-target">
                    ×”×¢×œ×”
                </button>
                <p class="text-[11px] text-cozy-brown">
                    × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×§×‘×¦×™× ××¨×•×‘×™× Â· ×¢×“ 50MB ×œ×›×œ ×§×•×‘×¥
                </p>
            </form>
        </div>
    </div>

    <!-- Documents list -->
    {% if documents %}
    <div class="space-y-2 max-h-[460px] overflow-y-auto pr-1">
        {% for doc in documents %}
        <details class="group bg-cream-light/70 border border-cream-dark/40 rounded-xl px-3 py-2.5 open:bg-cream-light shadow-sm open:shadow-md transition-all">
            <summary class="flex items-center justify-between gap-3 cursor-pointer list-none">
                <div class="flex flex-col min-w-0">
                    <p class="text-sm font-semibold text-dark-brown truncate" title="{{ doc.original_filename or doc.filename }}">
                        {{ doc.original_filename or doc.filename }}
                    </p>
                    <div class="flex flex-wrap items-center gap-2 text-[11px] text-cozy-brown mt-0.5">
                        <span>
                            {{ ((doc.file_size or 0) / 1024)|round|int }} KB
                        </span>
                        <span>â€¢</span>
                        <span>
                            {{ doc.content_type or 'file' }}
                        </span>
                        {% if doc.created_at %}
                            <span>â€¢</span>
                            <span>{{ doc.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0">
                    {# STATUS BADGE BASED ON CONTENT_TEXT PLACEHOLDER #}
                    {% if '[Processing file' in (doc.content_text or '') or '[Processing' in (doc.content_text or '') or '[×©×’×™××”' in (doc.content_text or '') %}
                        <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-800 text-[11px] px-2 py-0.5">
                            ×‘×¢×™×‘×•×“...
                        </span>
                    {% else %}
                        <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 text-[11px] px-2 py-0.5">
                            ××•×›×Ÿ
                        </span>
                    {% endif %}
                    <span class="text-xs text-cozy-brown group-open:rotate-180 transition-transform">
                        â–¼
                    </span>
                </div>
            </summary>

            <!-- Expanded content: mini-summary + subjects + actions -->
            <div class="mt-3 border-t border-cream-dark/40 pt-3 space-y-2 text-xs">
                {# Mini summary from content_text (first ~250 chars) #}
                {% set full_text = (doc.content_text or '') %}
                {% if full_text %}
                    {% set snippet = full_text[:250] %}
                    <p class="text-dark-brown leading-snug">
                        <span class="font-semibold">×ª×§×¦×™×¨ ×§×¦×¨ (××•×˜×•××˜×™):</span>
                        {{ snippet }}{% if full_text|length > 250 %}...{% endif %}
                    </p>
                {% else %}
                    <p class="text-cozy-brown italic">
                        ×˜×¨× × ×•×¦×¨ ×ª×§×¦×™×¨ ×œ××¡××š ×”×–×”. ×›×œ×™ ×”-AI ×™×©×ª××©×• ×‘×ª×•×›×Ÿ ×›×©×”×¢×™×‘×•×“ ×™×¡×ª×™×™×.
                    </p>
                {% endif %}

                {# Optional subjects/tags if you decide to store them later (e.g. doc.subjects) #}
                {% if doc.subjects %}
                    <div class="flex flex-wrap gap-1.5">
                        {% for tag in doc.subjects %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-cream-dark/60 text-[11px] text-dark-brown">
                                #{{ tag }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="flex flex-wrap gap-2 pt-1">
                    <a href="{{ url_for('library.course_tool', course_id=course.id, tool='summary') }}"
                       class="text-[11px] px-2 py-1 rounded-full bg-golden-yellow text-dark-brown hover:bg-warm-yellow transition-colors">
                        ×¡×›× ××¡××š ×–×”
                    </a>
                    <a href="{{ url_for('library.course_tool', course_id=course.id, tool='flashcards') }}"
                       class="text-[11px] px-2 py-1 rounded-full bg-cream-dark text-dark-brown hover:bg-cozy-brown hover:text-cream transition-colors">
                        ×¦×•×¨ ×›×¨×˜×™×¡×™×•×ª
                    </a>
                    <a href="{{ url_for('library.course_tool', course_id=course.id, tool='assess') }}"
                       class="text-[11px] px-2 py-1 rounded-full bg-cream-dark text-dark-brown hover:bg-cozy-brown hover:text-cream transition-colors">
                        ×¦×•×¨ ×©××œ×•×ª
                    </a>
                    <button type="button"
                            onclick="deleteDocument('{{ doc._id }}')"
                            class="text-[11px] px-2 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors">
                        ××—×§ ××¡××š
                    </button>
                </div>
            </div>
        </details>
        {% endfor %}
    </div>

    <p class="text-xs text-cozy-brown mt-3">
        {{ documents|length }} ××¡××›×™× ×‘×§×•×¨×¡
    </p>
    {% else %}
    <p class="text-cozy-brown text-sm">
        ××™×Ÿ ××¡××›×™× ×‘×§×•×¨×¡ â€“ ××‘×œ ×–×” ××¦×‘ ×©×××•×¨ ×œ×”×™×•×ª × ×“×™×¨, ×›×™ has_content = True ğŸ˜Š
    </p>
    {% endif %}
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Constants
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    const MAX_FILE_SIZE_MB = 50;

    // iOS detection
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    // Helper function to validate file size
    function validateFileSize(file) {
        if (!file || file.size === 0) return { valid: false, error: '×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×œ×”×¢×œ××” ğŸ“' };

        if (file.size > MAX_FILE_SIZE) {
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            return {
                valid: false,
                error: `âŒ ×”×§×•×‘×¥ ×’×“×•×œ ××“×™! ×’×•×“×œ ××§×¡×™××œ×™: ${MAX_FILE_SIZE_MB}MB\n×’×•×“×œ ×”×§×•×‘×¥ ×©×œ×š: ${fileSizeMB}MB`
            };
        }

        return { valid: true };
    }

    // Helper function to get the correct upload endpoint
    function getUploadEndpoint(hasFiles) {
        // Use faster GridFS endpoint for files, regular endpoint for text only
        return hasFiles ? '/api/upload/files' : '/api/upload/';
    }

    // iOS-specific: Add visual feedback for file input selection
    if (isIOS) {
        var fileInputs = document.querySelectorAll('input[type="file"]');
        for (var i = 0; i < fileInputs.length; i++) {
            (function(input) {
                input.addEventListener('change', function(e) {
                    if (this.files && this.files.length > 0) {
                        console.log('File selected on iOS:', this.files[0].name);
                        // Add visual feedback that file was selected
                        var fileName = this.files[0].name;
                        var fileSizeKB = (this.files[0].size / 1024).toFixed(0);

                        // Create a subtle notification
                        var notification = document.createElement('div');
                        notification.textContent = 'âœ“ ' + fileName + ' (' + fileSizeKB + 'KB)';
                        notification.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #F2C94C; color: #4B2E16; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                        document.body.appendChild(notification);

                        setTimeout(function() {
                            notification.style.transition = 'opacity 0.3s';
                            notification.style.opacity = '0';
                            setTimeout(function() {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 300);
                        }, 2000);
                    }
                });

                // iOS-specific: Ensure file input is tappable
                input.style.cursor = 'pointer';
                input.style.minHeight = '48px';
            })(fileInputs[i]);
        }
    }

    // Upload form handler (empty-course state) - multiple files supported
    const uploadForm = document.getElementById('upload-form');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const formData = new FormData(this);
            const submitBtn = document.getElementById('upload-submit-btn');
            const statusDiv = document.getElementById('upload-status');
            const statusText = document.getElementById('upload-status-text');
            const avnerImg = document.getElementById('upload-avner-img');

            const textInput = formData.get('text');
            const fileInput = document.getElementById('file-input-main');
            const files = fileInput ? fileInput.files : [];

            if ((!textInput || textInput.trim() === '') && files.length === 0) {
                alert('×™×© ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ××• ×œ×‘×—×•×¨ ×§×•×‘×¥ ×œ×”×¢×œ××” ğŸ“');
                return;
            }

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const validation = validateFileSize(files[i]);
                    if (!validation.valid) {
                        alert(validation.error);
                        return;
                    }
                }
            }

            statusDiv.classList.remove('hidden');
            avnerImg.src = "{{ url_for('serve_avner', filename='loading.jpeg') }}";
            avnerImg.classList.add('animate-pulse');

            if (files.length > 1) {
                statusText.textContent = `××¢×œ×” ${files.length} ×§×‘×¦×™×...`;
            } else if (files.length === 1) {
                statusText.textContent = '××¢×œ×” ××ª ×”×§×•×‘×¥...';
            } else {
                statusText.textContent = '×©×•××¨ ×˜×§×¡×˜...';
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-75');

            const uploadUrl = getUploadEndpoint(files.length > 0);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', uploadUrl, true);

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        JSON.parse(xhr.responseText);

                        avnerImg.src = "{{ url_for('serve_avner', filename='avner_celebrating.jpeg') }}";
                        avnerImg.classList.remove('animate-pulse');

                        if (files.length > 1) {
                            statusText.textContent = `âœ… ${files.length} ×§×‘×¦×™× ×”×•×¢×œ×• ×‘×”×¦×œ×—×”!`;
                        } else {
                            statusText.textContent = 'âœ… ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!';
                        }

                        setTimeout(function() { window.location.reload(); }, 800);
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        statusDiv.classList.add('hidden');
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-75');
                        alert('âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×’×•×‘×” ××”×©×¨×ª');
                    }
                } else {
                    statusDiv.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-75');
                    try {
                        const data = JSON.parse(xhr.responseText);
                        const errorMsg = data.error || '××™×¨×¢×” ×©×’×™××” ×‘×”×¢×œ××”. ×× × × ×¡×” ×©×•×‘';
                        alert('âŒ ×©×’×™××”: ' + errorMsg);
                    } catch (e) {
                        alert('âŒ ×©×’×™××” ×‘×”×¢×œ××”. ×× × × ×¡×” ×©×•×‘.');
                    }
                }
            };

            xhr.onerror = function() {
                statusDiv.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75');
                alert('âŒ ×©×’×™××” ×‘×”×¢×œ××”. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘.');
                console.error('Upload error: Network error');
            };

            xhr.send(formData);
        });
    }

    // Upload more form handler (course has content) - multiple files supported
    const uploadMoreForm = document.getElementById('upload-more-form');
    if (uploadMoreForm) {
        uploadMoreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            const fileInput = document.getElementById('file-input-more');
            const files = fileInput ? fileInput.files : [];

            if (files.length === 0) {
                alert('×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×œ×”×¢×œ××” ğŸ“');
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const validation = validateFileSize(files[i]);
                if (!validation.valid) {
                    alert(validation.error);
                    return;
                }
            }

            submitBtn.disabled = true;
            if (files.length > 1) {
                submitBtn.innerHTML = '<img src="{{ url_for('serve_avner', filename='loading.jpeg') }}" class="w-6 h-6 inline-block animate-pulse"> ××¢×œ×” ' + files.length + ' ×§×‘×¦×™×...';
            } else {
                submitBtn.innerHTML = '<img src="{{ url_for('serve_avner', filename='loading.jpeg') }}" class="w-6 h-6 inline-block animate-pulse"> ××¢×œ×”...';
            }

            const xhr = new XMLHttpRequest();
            xhr.open('POST', getUploadEndpoint(true), true);

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        JSON.parse(xhr.responseText);
                        submitBtn.innerHTML = 'âœ… ×”×•×¢×œ×”!';
                        setTimeout(function() { window.location.reload(); }, 500);
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        alert('âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×’×•×‘×” ××”×©×¨×ª');
                    }
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    try {
                        const data = JSON.parse(xhr.responseText);
                        const errorMsg = data.error || '××™×¨×¢×” ×©×’×™××” ×‘×”×¢×œ××”. ×× × × ×¡×” ×©×•×‘';
                        alert('âŒ ×©×’×™××”: ' + errorMsg);
                    } catch (e) {
                        alert('âŒ ×©×’×™××” ×‘×”×¢×œ××”. ×× × × ×¡×” ×©×•×‘.');
                    }
                }
            };

            xhr.onerror = function() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('âŒ ×©×’×™××” ×‘×”×¢×œ××”. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘.');
                console.error('Upload error: Network error');
            };

            xhr.send(formData);
        });
    }

    // Delete document function
    function deleteDocument(docId) {
        if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××¡××š? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.')) {
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open('DELETE', '/api/upload/files/' + docId, true);

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                alert('×”××¡××š × ××—×§ ×‘×”×¦×œ×—×”!');
                window.location.reload();
            } else {
                try {
                    var data = JSON.parse(xhr.responseText);
                    alert('×©×’×™××” ×‘××—×™×§×ª ×”××¡××š: ' + (data.error || '× ×¡×” ×©×•×‘'));
                } catch (e) {
                    alert('×©×’×™××” ×‘××—×™×§×ª ×”××¡××š. × ×¡×” ×©×•×‘.');
                }
            }
        };

        xhr.onerror = function() {
            console.error('Delete error: Network error');
            alert('×©×’×™××” ×‘××—×™×§×ª ×”××¡××š. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
        };

        xhr.send();
    }

    // Fallback ask-about-course helper if ever used
    function askAboutCourse() {
        window.location.href = "{{ url_for('library.course_tool', course_id=course.id, tool='tutor') }}";
    }
</script>
{% endblock %}
