{% extends "base.html" %}

{% block title %}××©×™××•×ª - {{ course.name }} - StudyBuddy{% endblock %}

{% block content %}
<!-- Breadcrumb & Header -->
<div class="mb-6">
    <nav class="text-sm text-cozy-brown mb-2" aria-label="× ×™×•×•×˜ ×¤×™×¨×•×¨×™ ×œ×—×">
        <a href="{{ url_for('library.index') }}" class="hover:text-golden-yellow transition-colors">
            ğŸ“š ×”×¡×¤×¨×™×™×”
        </a>
        <span class="mx-2">/</span>
        <a href="{{ url_for('library.course_page', course_id=course.id) }}" class="hover:text-golden-yellow transition-colors">
            {{ course.icon }} {{ course.name }}
        </a>
        <span class="mx-2">/</span>
        <span class="text-dark-brown">ğŸ“‹ ××©×™××•×ª</span>
    </nav>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
            <span class="text-4xl" aria-hidden="true">ğŸ“‹</span>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-dark-brown">
                    ××©×™××•×ª ×”×§×•×¨×¡
                </h1>
                <p class="text-cozy-brown text-sm mt-1">
                    {{ course.icon }} {{ course.name }}
                </p>
            </div>
        </div>
        <a href="{{ url_for('library.course_page', course_id=course.id) }}"
           class="px-4 py-2 bg-golden-yellow text-dark-brown font-medium rounded-xl hover:bg-warm-yellow transition-colors">
            â† ×—×–×•×¨ ×œ×§×•×¨×¡
        </a>
    </div>
</div>

<!-- Task Statistics -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4" aria-label="×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×™××•×ª">
    <div class="bg-cream rounded-xl p-4 border-2 border-warm-yellow text-center">
        <div class="text-2xl font-bold text-dark-brown">{{ task_stats.total }}</div>
        <div class="text-xs text-cozy-brown mt-1">×¡×”"×› ××©×™××•×ª</div>
    </div>
    <div class="bg-success/10 rounded-xl p-4 border-2 border-success text-center">
        <div class="text-2xl font-bold text-success">{{ task_stats.completed }}</div>
        <div class="text-xs text-cozy-brown mt-1">âœ… ×”×•×©×œ××•</div>
    </div>
    <div class="bg-golden-yellow/20 rounded-xl p-4 border-2 border-golden-yellow text-center">
        <div class="text-2xl font-bold text-cozy-brown">{{ task_stats.processing }}</div>
        <div class="text-xs text-cozy-brown mt-1">â³ ×‘×¢×™×‘×•×“</div>
    </div>
    <div class="bg-red-100 rounded-xl p-4 border-2 border-red-400 text-center">
        <div class="text-2xl font-bold text-red-600">{{ task_stats.failed }}</div>
        <div class="text-xs text-cozy-brown mt-1">âŒ × ×›×©×œ×•</div>
    </div>
    <div class="bg-blue-100 rounded-xl p-4 border-2 border-blue-400 text-center">
        <div class="text-2xl font-bold text-blue-600">{{ task_stats.pending }}</div>
        <div class="text-xs text-cozy-brown mt-1">â¸ï¸ ×××ª×™× ×•×ª</div>
    </div>
</div>

{# ===== NEW: derived stats about uploaded files + ready tools (minimal logic, no backend changes) ===== #}
{% if tasks %}
    {% set ns = namespace(
        total_files=0,
        processed_files=0,
        summary_ready=0,
        flashcards_ready=0,
        assess_ready=0,
        homework_ready=0
    ) %}

    {% if tasks_by_type %}
        {% for t_type, type_tasks in tasks_by_type.items() %}
            {% if t_type == 'file_processing' %}
                {% set ns.total_files = ns.total_files + (type_tasks|length) %}
                {% for task in type_tasks %}
                    {% if task.status == 'COMPLETED' %}
                        {% set ns.processed_files = ns.processed_files + 1 %}
                    {% endif %}
                {% endfor %}
            {% elif t_type == 'summary' %}
                {% for task in type_tasks %}
                    {% if task.status == 'COMPLETED' %}
                        {% set ns.summary_ready = ns.summary_ready + 1 %}
                    {% endif %}
                {% endfor %}
            {% elif t_type == 'flashcards' %}
                {% for task in type_tasks %}
                    {% if task.status == 'COMPLETED' %}
                        {% set ns.flashcards_ready = ns.flashcards_ready + 1 %}
                    {% endif %}
                {% endfor %}
            {% elif t_type == 'assess' %}
                {% for task in type_tasks %}
                    {% if task.status == 'COMPLETED' %}
                        {% set ns.assess_ready = ns.assess_ready + 1 %}
                    {% endif %}
                {% endfor %}
            {% elif t_type == 'homework' %}
                {% for task in type_tasks %}
                    {% if task.status == 'COMPLETED' %}
                        {% set ns.homework_ready = ns.homework_ready + 1 %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="mb-6 bg-cream rounded-xl p-4 border border-warm-yellow text-sm text-cozy-brown">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
                <span class="font-semibold text-dark-brown">×¡×˜×˜×•×¡ ×§×‘×¦×™×:</span>
                <span class="ml-2">
                    ×§×‘×¦×™× ×©×”×•×¢×œ×•: {{ ns.total_files }},
                    ×§×‘×¦×™× ×©×¢×•×‘×“×•: {{ ns.processed_files }}
                </span>
            </div>
            <div>
                <span class="font-semibold text-dark-brown">×›×œ×™× ××•×›× ×™× ×œ×©×™××•×©:</span>
                <span class="ml-2">
                    {% set any_ready = false %}
                    {% if ns.summary_ready > 0 %}
                        {% set any_ready = true %}
                        ğŸ“ ×¡×™×›×•××™× ({{ ns.summary_ready }})
                    {% endif %}
                    {% if ns.flashcards_ready > 0 %}
                        {% if any_ready %} Â· {% endif %}
                        {% set any_ready = true %}
                        ğŸƒ ×›×¨×˜×™×¡×™×•×ª ({{ ns.flashcards_ready }})
                    {% endif %}
                    {% if ns.assess_ready > 0 %}
                        {% if any_ready %} Â· {% endif %}
                        {% set any_ready = true %}
                        âœ… ×‘×—× ×™× ({{ ns.assess_ready }})
                    {% endif %}
                    {% if ns.homework_ready > 0 %}
                        {% if any_ready %} Â· {% endif %}
                        {% set any_ready = true %}
                        ğŸ“š ×©×™×¢×•×¨×™ ×‘×™×ª ({{ ns.homework_ready }})
                    {% endif %}
                    {% if not any_ready %}
                        ×¢×“×™×™×Ÿ ××™×Ÿ ×ª×•×¦××•×ª ××•×›× ×•×ª â€“ ×”×©×ª××©×• ×‘×›×œ×™× ×›×“×™ ×œ×”×ª×—×™×œ âœ¨
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
{% endif %}
{# ===== END NEW PART ===== #}

{% if not tasks %}
<!-- Empty State -->
<div class="bg-cream rounded-2xl p-8 shadow-md border-2 border-warm-yellow text-center">
    <img
        src="{{ url_for('static', filename='avner/avner_looking_at_page_acratching_head.jpeg') }}"
        alt="××‘× ×¨ ××‘×™×˜ ×‘×“×£ ×•××’×¨×“ ××ª ×”×¨××© â€“ ××™×Ÿ ××©×™××•×ª ×¢×“×™×™×Ÿ"
        class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-golden-yellow shadow-md"
    >
    <h2 class="text-xl font-bold text-dark-brown mb-2">××™×Ÿ ××©×™××•×ª ×¢×“×™×™×Ÿ ğŸ“­</h2>
    <p class="text-cozy-brown mb-4">
        ×›×©×ª×©×ª××© ×‘×›×œ×™× ×©×œ ××‘× ×¨ (×¡×™×›×•××™×, ×›×¨×˜×™×¡×™×•×ª, ×‘×—× ×™×), <br>
        ×ª×¨××” ×›××Ÿ ××ª ×›×œ ×”××©×™××•×ª ×•××¦×‘×Ÿ.
    </p>
    <a href="{{ url_for('library.course_page', course_id=course.id) }}"
       class="inline-block bg-golden-yellow text-dark-brown font-bold py-2 px-6 rounded-xl hover:bg-warm-yellow transition-colors">
        ×”×©×ª××© ×‘×›×œ×™×
    </a>
</div>

{% else %}
<!-- Tasks by Type -->
<div class="space-y-6">
    {% for task_type, type_tasks in tasks_by_type.items() %}
    <section class="bg-cream rounded-xl p-5 shadow-md border border-warm-yellow" aria-label="××©×™××•×ª ××¡×•×’ {{ task_type }}">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-dark-brown flex items-center gap-2">
                {% if task_type == 'summary' %}
                    ğŸ“ ×¡×™×›×•××™×
                {% elif task_type == 'flashcards' %}
                    ğŸƒ ×›×¨×˜×™×¡×™×•×ª
                {% elif task_type == 'assess' %}
                    âœ… ×‘×—× ×™×
                {% elif task_type == 'homework' %}
                    ğŸ“š ×©×™×¢×•×¨×™ ×‘×™×ª
                {% elif task_type == 'file_processing' %}
                    ğŸ“¤ ×¢×™×‘×•×“ ×§×‘×¦×™×
                {% else %}
                    ğŸ“‹ {{ task_type }}
                {% endif %}
            </h2>
            <span class="text-sm text-cozy-brown">{{ type_tasks|length }} ××©×™××•×ª</span>
        </div>

        <div class="space-y-3">
            {% for task in type_tasks %}
            <article class="bg-warm-beige rounded-lg p-4 flex items-center justify-between gap-4 hover:bg-warm-yellow/30 transition-colors">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        {% if task.status == 'COMPLETED' %}
                            <span class="text-success text-sm font-medium">âœ… ×”×•×©×œ×</span>
                        {% elif task.status == 'PROCESSING' %}
                            <span class="text-golden-yellow text-sm font-medium">â³ ×‘×¢×™×‘×•×“...</span>
                        {% elif task.status == 'FAILED' %}
                            <span class="text-red-600 text-sm font-medium">âŒ × ×›×©×œ</span>
                        {% elif task.status == 'PENDING' %}
                            <span class="text-blue-600 text-sm font-medium">â¸ï¸ ×××ª×™×Ÿ</span>
                        {% endif %}

                        <span class="text-xs text-cozy-brown">
                            {{ task.created_at.strftime('%d/%m/%Y %H:%M') if task.created_at else '×œ× ×™×“×•×¢' }}
                        </span>
                    </div>

                    {# IMPORTANT:
                       Make sure task.error_message is already sanitized / user-friendly on the backend.
                       Do NOT pass raw stack traces or internal details here. #}
                    {% if task.error_message %}
                    <div class="text-xs text-red-600 mt-1">
                        ×©×’×™××”: {{ task.error_message }}
                    </div>
                    {% endif %}

                    {% if task.task_type == 'file_processing' and task.status == 'COMPLETED' %}
                    <div class="text-xs text-success mt-1">
                        âœ“ ×”×§×•×‘×¥ ×¢×•×‘×“ ×•×”×•×›× ×¡ ×œ××¡××›×™ ×”×§×•×¨×¡
                    </div>
                    {% endif %}
                </div>

                <div class="flex items-center gap-2">
                    {% if task.status == 'COMPLETED' and task.result_id %}
                        {% if task.task_type == 'summary' %}
                            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='summary') }}"
                               class="text-xs bg-golden-yellow text-dark-brown px-3 py-1 rounded-full hover:bg-warm-yellow transition-colors">
                                ×¦×¤×”
                            </a>
                        {% elif task.task_type == 'flashcards' %}
                            <a href="{{ url_for('library.course_tool', course_id=course.id, tool='flashcards') }}"
                               class="text-xs bg-golden-yellow text-dark-brown px-3 py-1 rounded-full hover:bg-warm-yellow transition-colors">
