{% extends "base.html" %}

{% block title %}ğŸ’¬ ×¦'××˜ ×¢× ××‘× ×¨ - StudyBuddyAI{% endblock %}

{% block content %}
<div class="space-y-6 text-right">
    <!-- Header -->
    <div class="flex items-start gap-4">
        <img src="{{ url_for('serve_avner', filename='avner_waving.jpeg') }}" 
             alt="××‘× ×¨ ×× ×•×¤×£" 
             class="w-20 h-20 rounded-full object-cover border-4 border-golden-yellow shadow-warm flex-shrink-0">
        <div class="flex-grow">
            <h1 class="text-3xl font-bold text-dark-brown">ğŸ’¬ ×©×•×—×— ×¢× ××‘× ×¨</h1>
            <p class="text-cozy-brown mt-1 text-lg">×ª×©××œ ××•×ª×™ ×›×œ ×“×‘×¨! ×× ×™ ×›××Ÿ ×œ×¢×–×•×¨ ğŸ¦«</p>
        </div>
    </div>

    <!-- Baby Mode Toggle -->
    <div class="content-card border-2 border-warm-yellow bg-gradient-to-l from-warm-beige to-cream">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="{{ url_for('serve_avner', filename='baby_avner.png') }}" 
                     alt="××‘× ×¨ ×”×§×˜×Ÿ" 
                     class="w-14 h-14 rounded-full object-cover border-3 border-golden-yellow shadow-sm"
                     id="baby-mode-image">
                <div>
                    <h3 class="text-lg font-bold text-dark-brown">ğŸ¼ ××¦×‘ ××‘× ×¨ ×”×§×˜×Ÿ</h3>
                    <p class="text-sm text-cozy-brown">×”×¡×‘×¨×™× ×¤×©×•×˜×™× ×¢× ×“×•×’×××•×ª ××”×—×™×™×</p>
                </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="baby-mode-toggle" class="sr-only peer">
                <div class="w-14 h-7 bg-warm-gray rounded-full peer peer-checked:bg-golden-yellow peer-focus:ring-2 peer-focus:ring-warm-yellow transition-colors">
                    <div class="dot absolute right-1 top-1 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-[-28px]"></div>
                </div>
            </label>
        </div>
    </div>

    <!-- Course Selector (if authenticated) -->
    {% if current_user.is_authenticated %}
    <div class="content-card bg-warm-beige">
        <label for="course-selector" class="block text-sm font-bold text-dark-brown mb-2">
            ğŸ“š ×‘×—×¨ ×§×•×¨×¡ (××•×¤×¦×™×•× ×œ×™):
        </label>
        <select id="course-selector" class="form-input text-right" style="font-size: 16px;">
            <option value="">×›×œ ×”×—×•××¨×™× ×©×œ×™</option>
            {% if courses %}
                {% for course in courses %}
                <option value="{{ course._id }}">{{ course.icon }} {{ course.name }}</option>
                {% endfor %}
            {% endif %}
        </select>
        <p class="text-xs text-warm-gray mt-2">××‘× ×¨ ×™×¢× ×” ×¢×œ ×‘×¡×™×¡ ×”×—×•××¨ ××”×§×•×¨×¡ ×©×ª×‘×—×¨</p>
    </div>
    {% endif %}

    <!-- Chat Container with flowing design -->
    <div class="content-card min-h-[500px] flex flex-col bg-gradient-to-b from-cream to-warm-beige">
        <!-- Messages Area with flowing chat design -->
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-white/50 rounded-lg border-2 border-warm-yellow mb-4 shadow-inner mobile-scroll" style="max-height: 60vh; min-height: 300px;">
            <!-- Welcome Message -->
            <div class="flex gap-3 items-start animate-fade-in">
                <img src="{{ url_for('serve_avner', filename='avner_signing_ok.jpeg') }}" 
                     alt="××‘× ×¨" 
                     class="w-10 h-10 rounded-full object-cover border-2 border-golden-yellow flex-shrink-0">
                <div class="flex-grow">
                    <div class="bg-gradient-to-l from-warm-beige to-cream p-3 rounded-2xl border-2 border-warm-yellow shadow-sm">
                        <p class="text-dark-brown"><strong>××‘× ×¨:</strong> ×”×™×™! ğŸ¦« ×× ×™ ××‘× ×¨, ×•×× ×™ ×›××Ÿ ×œ×¢×–×•×¨ ×œ×š ×œ×œ××•×“. ××” ×ª×¨×¦×” ×œ×“×¢×ª?</p>
                    </div>
                    <p class="text-xs text-warm-gray mt-1">×¢×›×©×™×•</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <form id="chat-form" class="flex gap-2 flex-col sm:flex-row">
            <textarea 
                id="question-input" 
                name="question"
                class="flex-grow p-3 border-2 border-warm-yellow rounded-lg text-right resize-none focus:ring-2 focus:ring-golden-yellow focus:border-golden-yellow mobile-scroll"
                style="font-size: 16px; min-height: 64px;"
                rows="2"
                placeholder="×›×ª×•×‘ ××ª ×”×©××œ×” ×©×œ×š ×›××Ÿ..."
                required></textarea>
            <button type="submit" 
                    class="btn-primary px-6 self-end hover:scale-105 transition-transform mobile-touch-target w-full sm:w-auto"
                    id="send-button">
                ğŸ“¤ ×©×œ×—
            </button>
        </form>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden mt-2 flex items-center gap-2 text-warm-gray text-sm">
            <div class="animate-spin h-4 w-4 border-2 border-golden-yellow border-t-transparent rounded-full"></div>
            <span>××‘× ×¨ ×—×•×©×‘...</span>
        </div>

        <!-- Prompts Counter (if authenticated) -->
        {% if current_user.is_authenticated %}
        <div id="prompts-counter" class="mt-2 text-xs text-warm-gray text-center">
            <!-- Will be updated via responses -->
        </div>
        {% endif %}
    </div>

    <!-- Quick Tips -->
    <div class="content-card bg-gradient-to-l from-warm-yellow/20 to-cream border-l-4 border-golden-yellow">
        <h3 class="font-bold text-dark-brown mb-2 flex items-center gap-2">
            ğŸ’¡ ×˜×™×¤×™× ××”×™×¨×™×
        </h3>
        <ul class="text-sm text-cozy-brown space-y-1">
            <li>â€¢ ××¤×©×¨ ×œ×©××•×œ ×¢×œ ×”××¤×œ×™×§×¦×™×” (××™×š ××©×ª××©×™× ×‘×›×œ×™×)</li>
            <li>â€¢ ××¤×©×¨ ×œ×©××•×œ ×©××œ×•×ª ×œ×™××•×“×™×•×ª ×¢×œ ×”×—×•××¨ ×©×”×¢×œ×™×ª</li>
            <li>â€¢ ×”×©×ª××© ×‘××¦×‘ "××‘× ×¨ ×”×§×˜×Ÿ" ×œ×”×¡×‘×¨×™× ×¤×©×•×˜×™× ×™×•×ª×¨</li>
            <li>â€¢ ×‘×—×¨ ×§×•×¨×¡ ×¡×¤×¦×™×¤×™ ×›×“×™ ×œ×§×‘×œ ×ª×©×•×‘×•×ª ×××•×§×“×•×ª</li>
        </ul>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const questionInput = document.getElementById('question-input');
    const chatMessages = document.getElementById('chat-messages');
    const loadingIndicator = document.getElementById('loading-indicator');
    const babyModeToggle = document.getElementById('baby-mode-toggle');
    const courseSelector = document.getElementById('course-selector');
    const promptsCounter = document.getElementById('prompts-counter');

    // Avner personality variations - MORE IMAGES FOR COMEDY!
    const avnerImages = {
        thinking: '{{ url_for("serve_avner", filename="avner_thinking.jpeg") }}',
        happy: '{{ url_for("serve_avner", filename="avner_signing_ok.jpeg") }}',
        explaining: '{{ url_for("serve_avner", filename="avner_reading.jpeg") }}',
        baby: '{{ url_for("serve_avner", filename="baby_avner.png") }}',
        encouraging: '{{ url_for("serve_avner", filename="avner_celebrating.jpeg") }}',
        sarcastic: '{{ url_for("serve_avner", filename="avner_says_nope.jpeg") }}',
        confused: '{{ url_for("serve_avner", filename="avner_cluless.jpeg") }}',
        excited: '{{ url_for("serve_avner", filename="avner_horay.jpeg") }}',
        dancing: '{{ url_for("serve_avner", filename="avner_dancing.jpeg") }}',
        tired: '{{ url_for("serve_avner", filename="avner_tierd.jpeg") }}',
        coffee: '{{ url_for("serve_avner", filename="avner_drinnking_coffee.jpeg") }}',
        studying: '{{ url_for("serve_avner", filename="avner_studing.jpeg") }}',
        laptop: '{{ url_for("serve_avner", filename="avner_with_laptop.jpeg") }}',
        smoking: '{{ url_for("serve_avner", filename="avner_smoking.jpeg") }}',
        drinking: '{{ url_for("serve_avner", filename="avner_holding_whiskey.jpeg") }}',
        love: '{{ url_for("serve_avner", filename="avner_in_love.jpeg") }}',
        laughing: '{{ url_for("serve_avner", filename="avner_laghting.jpeg") }}',
        annoyed: '{{ url_for("serve_avner", filename="avner_annoied.jpeg") }}',
        nope: '{{ url_for("serve_avner", filename="avner_says_nope.jpeg") }}'
    };

    // Capybara jokes and funny sayings!
    const capybaraJokes = [
        'ğŸ¦« ×™×“×¢×ª? ×§×¤×™×‘×¨×•×ª ×”×Ÿ ×”×™×¦×•×¨×™× ×”×›×™ ×¦\'×™×œ ×‘×¢×•×œ× - ×›××• ××‘× ×¨ ××—×¨×™ ×§×¤×”!',
        'ğŸ¦« ×§×¤×™×‘×¨×” ×–×” ×‘×¢×¦× "× ×™×¤×•×¦\'×•" ×‘×©×¤×” ×©×œ×”× - ×›×Ÿ, ×—×™×¤×©×ª×™ ×‘×’×•×’×œ',
        'ğŸ¦« ×œ××” ×§×¤×™×‘×¨×•×ª ×ª××™×“ ×¨×’×•×¢×•×ª? ×›×™ ×”×Ÿ ×™×•×“×¢×•×ª ×©×”×›×œ ×™×¡×ª×“×¨ ×‘×¡×•×£!',
        'ğŸ¦« ×§×¤×™×‘×¨×•×ª ××•×”×‘×•×ª ×œ×©×›×‘ ×¢×œ ×”×“×©× - ××‘×œ ×¨×§ ××—×¨×™ ×©×”×Ÿ ×¡×™×™××• ××ª ×”×©×™×¢×•×¨×™×!',
        'ğŸ¦« ×™×“×¢×ª ×©×§×¤×™×‘×¨×•×ª ×”×Ÿ ×”×—×‘×¨×•×ª ×”×›×™ ×˜×•×‘×•×ª ×©×œ ×›×•×œ×? ××¤×™×œ×• ×ª× ×™× ×™× ××•×”×‘×™× ××•×ª×Ÿ!',
        'ğŸ¦« ×§×¤×™×‘×¨×” + ×œ×™××•×“×™× = ×”×¦×œ×—×” ××•×‘×˜×—×ª (×œ×¤×™ ××—×§×¨×™× ×©×œ ××‘× ×¨)',
        'ğŸ¦« Could this BE any more capybara? - ××‘× ×¨ ×‘×¡×’× ×•×Ÿ ×¦\'× ×“×œ×¨',
        'ğŸ¦« ×§×¤×™×‘×¨×•×ª ×œ× ×œ×•×—×¦×•×ª - ×•××ª×” ×’× ×œ× ×¦×¨×™×š! × ×©×‘, × ×ª×¨×›×–, ×•× ×¦×œ×™×—!'
    ];

    // Sarcastic/funny encouragements from Avner
    const avnerSarcasm = [
        'ğŸ˜ ×•×•××•, ×©××œ×” ×§×©×”... ××‘×œ ×¨××™×ª×™ ×§×©×•×ª ×™×•×ª×¨. ×‘×•× × ×ª××•×“×“!',
        'ğŸ¦« ×¢×•×“ ×©××œ×” ×›×–××ª ×•×× ×™ ×¦×¨×™×š ×—×•×¤×©×”... ××‘×œ ×‘×™× ×ª×™×™×, ×‘×•× × ×¢× ×”',
        'â˜• ×¨×’×¢, ×ª×Ÿ ×œ×™ ×œ×’××•×¨ ××ª ×”×§×¤×”... ××•×§×™×™, ××•×›×Ÿ!',
        'ğŸ˜… ××ª×” ×‘×˜×•×— ×©×–×• ×”×©××œ×”? ×‘×¡×“×¨, ×× ×™ ×¢×•×‘×“ ×¢×œ ×–×”...',
        'ğŸ¯ ××– ×–×” ××” ×©×¢×•×©×™× ×”×™×•×? ××¢× ×™×™×Ÿ! ×‘×•× × ×¨××”...',
        'ğŸ¤” ×”×××... ××¢× ×™×™×Ÿ. ×× ×™ ××“××’ ×©×ª×‘×™×Ÿ ××ª ×–×” (×’× ×× ×–×” ×™×§×— ×§×¦×ª ×–××Ÿ)',
        'ğŸ’ª ×–×” × ×¨××” ×§×©×”? ××‘× ×¨ ×œ× × ×¨×ª×¢ ×××ª×’×¨×™×! ×‘×•× × ×¢×©×” ××ª ×–×”!',
        'ğŸ˜ OK, ×–×” ××¡×•×‘×š ×§×¦×ª... ××‘×œ ×§×¤×™×‘×¨×•×ª ×œ× × ×›× ×¢×•×ª!'
    ];

    // Random encouraging messages
    const encouragements = [
        'ğŸŒŸ ××ª×” ×¢×•×©×” ××¢×•×œ×”! ×××©×™×š ×›×›×”!',
        'ğŸ’ª ×›×œ ×©××œ×” ××§×¨×‘×ª ××•×ª×š ×œ×”×¦×œ×—×”!',
        'ğŸš€ ×•×•××•! ××ª×” ××©×ª×¤×¨ ×¢× ×›×œ ×©××œ×”!',
        'â­ ×”××©×š ×›×›×” ×•×ª×”×™×” ××œ×•×£/×”!',
        'ğŸ¯ ×‘×•×œ! ×××© ×¢×œ ×–×”!',
        'ğŸ¦« ××‘× ×¨ ×’××” ×‘×š! (×¨×¦×™× ×™×ª)',
        'ğŸ‰ ×× ×œ××™×“×” ×”×™×™×ª×” ×¡×¤×•×¨×˜, ×”×™×™×ª ××œ×•×£ ×¢×•×œ×!',
        'ğŸ’¡ ×”××•×— ×©×œ×š ×¢×•×‘×“ ×‘×˜×™×¨×•×£ - ×× ×™ ××•×”×‘ ××ª ×–×”!'
    ];

    // Show random joke occasionally
    function maybeShowRandomJoke() {
        // 10% chance to show a joke
        if (Math.random() < 0.1) {
            const joke = capybaraJokes[Math.floor(Math.random() * capybaraJokes.length)];
            setTimeout(function() {
                addMessage(joke, false, 'laughing');
            }, 1000);
        }
    }

    // Show random encouragement
    function maybeShowEncouragement() {
        // 15% chance to show encouragement
        if (Math.random() < 0.15) {
            const msg = encouragements[Math.floor(Math.random() * encouragements.length)];
            setTimeout(function() {
                addMessage(msg, false, 'encouraging');
            }, 500);
        }
    }

    // Show random sarcasm
    function maybeShowSarcasm() {
        // 20% chance for sarcastic comment
        if (Math.random() < 0.2) {
            const msg = avnerSarcasm[Math.floor(Math.random() * avnerSarcasm.length)];
            return msg;
        }
        return null;
    }

    function pollTaskResult(taskId, babyMode, promptsUsed, promptsLimit) {
        const maxAttempts = 30; // 30 seconds max
        let attempts = 0;
        
        const poll = function() {
            attempts++;
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/tasks/' + taskId, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        
                        if (data.status === 'COMPLETED') {
                            loadingIndicator.classList.add('hidden');
                            
                            let imageVariant = babyMode ? 'baby' : 'explaining';
                            addMessage(data.result || '×× ×™ ×§×™×‘×œ×ª×™ ××ª ×”×ª×©×•×‘×”!', false, imageVariant);
                            
                            // Maybe show encouragement after answer
                            maybeShowEncouragement();
                            
                            if (promptsUsed && promptsLimit && promptsCounter) {
                                promptsCounter.textContent = '×©××œ×•×ª ×”×™×•×: ' + promptsUsed + '/' + promptsLimit;
                            }
                        } else if (data.status === 'FAILED') {
                            loadingIndicator.classList.add('hidden');
                            addMessage('××•×¤×¡! ××©×”×• ×”×©×ª×‘×© ×‘×¢×™×‘×•×“ ×”×©××œ×”. × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
                        } else if (attempts < maxAttempts) {
                            // Still processing, poll again
                            setTimeout(poll, 1000);
                        } else {
                            loadingIndicator.classList.add('hidden');
                            addMessage('××•×¤×¡! ×”×ª×’×•×‘×” ×œ×•×§×—×ª ×™×•×ª×¨ ××“×™ ×–××Ÿ. × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
                        }
                    } catch (e) {
                        loadingIndicator.classList.add('hidden');
                        addMessage('××•×¤×¡! ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×’×•×‘×” ğŸ¦«', false, 'sarcastic');
                    }
                } else if (attempts < maxAttempts) {
                    setTimeout(poll, 1000);
                } else {
                    loadingIndicator.classList.add('hidden');
                    addMessage('××•×¤×¡! ×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ×ª×©×•×‘×”. × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
                }
            };
            
            xhr.onerror = function() {
                if (attempts < maxAttempts) {
                    setTimeout(poll, 1000);
                } else {
                    loadingIndicator.classList.add('hidden');
                    addMessage('××•×¤×¡! ×‘×¢×™×™×ª ×—×™×‘×•×¨. × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
                }
            };
            
            xhr.send();
        };
        
        // Start polling after 500ms
        setTimeout(poll, 500);
    }

    function addMessage(content, isUser = false, imageVariant = 'happy') {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex gap-3 items-start animate-fade-in ' + (isUser ? 'flex-row-reverse' : '');
        
        const img = document.createElement('img');
        img.src = isUser ? '' : avnerImages[imageVariant];
        img.alt = isUser ? '××©×ª××©' : '××‘× ×¨';
        img.className = 'w-10 h-10 rounded-full object-cover border-2 border-golden-yellow flex-shrink-0';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-grow';
        
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-2xl border-2 shadow-sm ${isUser ? 'bg-gradient-to-r from-golden-yellow/30 to-warm-yellow/30 border-golden-yellow' : 'bg-gradient-to-l from-warm-beige to-cream border-warm-yellow'}`;
        
        const text = document.createElement('p');
        text.className = 'text-dark-brown whitespace-pre-wrap leading-relaxed';
        
        // Use textContent for security instead of innerHTML
        const label = document.createElement('strong');
        label.textContent = isUser ? '××ª/×”: ' : '××‘× ×¨: ';
        text.appendChild(label);
        text.appendChild(document.createTextNode(content));
        
        const time = document.createElement('p');
        time.className = 'text-xs text-warm-gray mt-1';
        time.textContent = '×¢×›×©×™×•';
        
        bubble.appendChild(text);
        contentDiv.appendChild(bubble);
        contentDiv.appendChild(time);
        
        if (!isUser) {
            messageDiv.appendChild(img);
        }
        messageDiv.appendChild(contentDiv);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Enhanced for iOS Safari compatibility
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const question = questionInput.value.trim();
        if (!question) return;
        
        // Maybe show sarcastic loading message
        const sarcasticMsg = maybeShowSarcasm();
        
        // Add user message
        addMessage(question, true);
        questionInput.value = '';
        
        // Show loading with optional sarcasm
        if (sarcasticMsg) {
            addMessage(sarcasticMsg, false, 'coffee');
        }
        loadingIndicator.classList.remove('hidden');
        
        // Maybe show a random joke while waiting
        maybeShowRandomJoke();
        
        // Use XMLHttpRequest for better iOS Safari compatibility
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/avner/ask', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        const babyMode = babyModeToggle.checked;
        const courseId = courseSelector ? courseSelector.value : '';
        
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    
                    if (data.error) {
                        loadingIndicator.classList.add('hidden');
                        addMessage('×©×’×™××”: ' + data.error, false, 'sarcastic');
                    } else if (data.answer) {
                        // Synchronous response (local answer)
                        loadingIndicator.classList.add('hidden');
                        let imageVariant = 'happy';
                        if (babyMode) {
                            imageVariant = 'baby';
                        } else if (data.used_ai) {
                            imageVariant = 'explaining';
                        }
                        
                        addMessage(data.answer, false, imageVariant);
                        
                        // Update prompts counter if available
                        if (data.prompts_used && data.prompts_limit && promptsCounter) {
                            promptsCounter.textContent = '×©××œ×•×ª ×”×™×•×: ' + data.prompts_used + '/' + data.prompts_limit;
                        }
                    } else if (data.task_id) {
                        // Asynchronous response (AI processing) - poll for result
                        pollTaskResult(data.task_id, babyMode, data.prompts_used, data.prompts_limit);
                    } else {
                        loadingIndicator.classList.add('hidden');
                        addMessage('××•×¤×¡! ×ª×’×•×‘×” ×œ× ×¦×¤×•×™×” ××”×©×¨×ª ğŸ¦«', false, 'sarcastic');
                    }
                } catch (parseError) {
                    loadingIndicator.classList.add('hidden');
                    console.error('Parse error:', parseError);
                    addMessage('××•×¤×¡! ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×’×•×‘×” ××”×©×¨×ª ğŸ¦«', false, 'sarcastic');
                }
            } else if (xhr.status === 202) {
                // Accepted - processing async
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.task_id) {
                        pollTaskResult(data.task_id, babyMode, data.prompts_used, data.prompts_limit);
                    }
                } catch (e) {
                    loadingIndicator.classList.add('hidden');
                    addMessage('××•×¤×¡! ×©×’×™××ª ×©×¨×ª. ×× × × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
                }
            } else {
                loadingIndicator.classList.add('hidden');
                addMessage('××•×¤×¡! ×©×’×™××ª ×©×¨×ª. ×× × × ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
            }
        };
        
        xhr.onerror = function() {
            loadingIndicator.classList.add('hidden');
            console.error('Network error');
            addMessage('××•×¤×¡! ××©×”×• ×”×©×ª×‘×© ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘ ğŸ¦«', false, 'sarcastic');
        };
        
        xhr.send(JSON.stringify({
            question: question,
            baby_mode: babyMode,
            course_id: courseId
        }));
    });

    // Enter to send (Shift+Enter for new line) - iOS 8 compatible
    questionInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            // iOS 8 compatible event dispatch
            if (typeof Event === 'function') {
                chatForm.dispatchEvent(new Event('submit'));
            } else {
                var event = document.createEvent('Event');
                event.initEvent('submit', true, true);
                chatForm.dispatchEvent(event);
            }
        }
    });

    // iOS-specific: Scroll chat into view when keyboard appears
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) {
        questionInput.addEventListener('focus', function() {
            // Small delay to ensure keyboard is shown
            setTimeout(function() {
                // iOS 8 compatible scrollIntoView
                if (questionInput.scrollIntoView) {
                    try {
                        questionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } catch (e) {
                        // Fallback for older iOS
                        questionInput.scrollIntoView(true);
                    }
                }
            }, 300);
        });
        
        // Ensure chat messages area is scrollable with momentum on iOS
        chatMessages.style.webkitOverflowScrolling = 'touch';
    }

    // Baby mode toggle effect
    babyModeToggle.addEventListener('change', function(e) {
        const image = document.getElementById('baby-mode-image');
        if (e.target.checked) {
            image.src = '{{ url_for("serve_avner", filename="baby_avner.png") }}';
            addMessage('×¢×‘×¨×ª×™ ×œ××¦×‘ ××‘× ×¨ ×”×§×˜×Ÿ! ğŸ¼ ×¢×›×©×™×• ×× ×™ ××¡×‘×™×¨ ×”×›×œ ×‘×¤×©×˜×•×ª ×¢× ×“×•×’×××•×ª ××”×—×™×™×!', false, 'baby');
        } else {
            image.src = '{{ url_for("serve_avner", filename="avner_signing_ok.jpeg") }}';
            addMessage('×—×–×¨×ª×™ ×œ××¦×‘ ×¨×’×™×œ! ğŸ¦« ××¤×©×¨ ×œ×”××©×™×š ×¢× ×©××œ×•×ª ×¨×’×™×œ×•×ª.', false, 'happy');
        }
    });
</script>

<style>
    /* Smooth animations for flowing chat */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    .animate-fade-in {
        animation: slideIn 0.4s ease-out;
    }
    
    /* Smooth scroll behavior for chat */
    #chat-messages {
        scroll-behavior: smooth;
    }
    
    /* Better chat bubble hover effects (respects reduced motion) */
    @media (prefers-reduced-motion: no-preference) {
        #chat-messages > div:hover {
            transform: translateX(2px);
            transition: transform 0.2s ease;
        }
    }
</style>
{% endblock %}
