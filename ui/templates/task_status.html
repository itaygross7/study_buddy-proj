<!-- ui/templates/task_status.html -->
{% set task_id = task.id if task is not mapping and task.id is defined else (task.get('id') if task is mapping else None) %}
{% if not task_id %}
  {% set task_id = task._id if task is not mapping and task._id is defined else (task.get('_id') if task is mapping else None) %}
{% endif %}

{% set status = task.status if task is not mapping and task.status is defined else (task.get('status') if task is mapping else None) %}
{% set task_type = task.task_type if task is not mapping and task.task_type is defined else (task.get('task_type') if task is mapping else None) %}
{% set result_id = task.result_id if task is not mapping and task.result_id is defined else (task.get('result_id') if task is mapping else None) %}
{% set next_tool_endpoint = task.next_tool_endpoint if task is not mapping and task.next_tool_endpoint is defined else (task.get('next_tool_endpoint') if task is mapping else None) %}
{% set error_message = task.error_message if task is not mapping and task.error_message is defined else (task.get('error_message') if task is mapping else None) %}

<div id="task-status-{{ task_id }}"
     hx-get="{{ url_for('task_bp.get_task_status_route', task_id=task_id) }}"
     hx-trigger="load delay:2s"
     hx-swap="outerHTML">

  {% if status in ['PENDING', 'PROCESSING'] %}
    <div class="p-4 rounded-2xl bg-blue-50/50 border border-blue-200">
      <div class="flex flex-col items-center text-center">
        <img src="{{ url_for('serve_avner', filename='avner_thinking.jpeg') }}"
             alt="אבנר חושב"
             class="h-20 mb-3">
        <p class="text-sm font-semibold text-blue-800">אני מעבד את הקובץ / המשימה...</p>
        <p class="text-xs text-blue-700 mt-1">סטטוס: {{ status }}</p>
      </div>
    </div>

  {% elif status == 'COMPLETED' %}
    {% if task_type == 'file_processing' and result_id and next_tool_endpoint %}
      <div class="p-4 rounded-2xl bg-yellow-50/50 border border-yellow-200"
           hx-post="{{ url_for(next_tool_endpoint, document_id=result_id) }}"
           hx-target="#task-status-{{ task_id }}"
           hx-swap="innerHTML"
           hx-trigger="load">
        <div class="flex flex-col items-center text-center">
          <img src="{{ url_for('serve_avner', filename='avner_notebook.jpeg') }}"
               alt="אבנר מתכונן"
               class="h-20 mb-3">
          <p class="text-sm font-semibold text-yellow-800">הקובץ עובד בהצלחה! מתחיל להכין את התוצאה...</p>
        </div>
      </div>

    {% elif result_id %}
      <div class="p-4 rounded-2xl bg-green-50/50 border border-green-200"
           hx-get="{{ url_for('results_bp.get_result', result_id=result_id) }}"
           hx-trigger="load"
           hx-target="#task-status-{{ task_id }}"
           hx-swap="innerHTML">
        <div class="flex flex-col items-center text-center">
          <img src="{{ url_for('serve_avner', filename='avner_success.jpeg') }}"
               alt="אבנר שמח"
               class="h-20 mb-3">
          <p class="text-sm font-semibold text-green-800">סיימתי! טוען את התוצאות...</p>
        </div>
      </div>

    {% else %}
      <div class="p-4 rounded-2xl bg-gray-50 border border-gray-200">
        <div class="flex flex-col items-center text-center">
          <p class="text-sm text-gray-700">המשימה הושלמה, אך לא נמצאו תוצאות להצגה.</p>
        </div>
      </div>
    {% endif %}

  {% elif status == 'FAILED' %}
    <div class="p-4 rounded-2xl bg-red-50/50 border border-red-200">
      <div class="flex flex-col items-center text-center">
        <img src="{{ url_for('serve_avner', filename='avner_confused.jpeg') }}"
             alt="אבנר מבולבל"
             class="h-20 mb-3">
        <h3 class="text-sm font-semibold text-red-800">אוי, משהו השתבש.</h3>
        <p class="mt-2 text-xs text-red-700">
          {{ error_message or 'קרתה שגיאה לא צפויה. נסה שוב מאוחר יותר.' }}
        </p>
      </div>
    </div>

  {% else %}
    <div class="p-4 rounded-2xl bg-gray-50 border border-gray-200">
      <div class="flex flex-col items-center text-center">
        <p class="text-sm text-gray-700">סטטוס לא ידוע: {{ status }}</p>
      </div>
    </div>
  {% endif %}
</div>
