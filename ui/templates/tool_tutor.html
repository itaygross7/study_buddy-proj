{% extends "base.html" %}

{% block title %}Interactive Tutor - StudyBuddyAI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex items-center gap-4">
            <img src="{{ url_for('serve_avner', filename='avner_studing.jpeg') }}" 
                 alt="Avner teaching" 
                 class="h-20 w-20 rounded-full object-cover border-4 border-warm-yellow"
                 onerror="this.style.display='none';">
            <div>
                <h1 class="text-3xl font-bold text-cozy-brown mb-2">üéì Interactive Tutor</h1>
                <p class="text-gray-600">Step-by-step learning with Avner</p>
            </div>
        </div>
    </div>

    <!-- Create Session Form -->
    <div id="createForm" class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-cozy-brown mb-4">Start a New Learning Session</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">What do you want to learn?</label>
                <input type="text" 
                       id="topicInput"
                       placeholder="e.g., Photosynthesis, Calculus derivatives, Object-oriented programming..."
                       class="w-full px-4 py-3 border-2 border-warm-yellow rounded-lg focus:outline-none focus:ring-2 focus:ring-caramel">
            </div>
            <button onclick="createSession()" 
                    class="w-full bg-caramel text-white px-6 py-3 rounded-lg hover:bg-cozy-brown transition-colors font-bold">
                üöÄ Start Learning
            </button>
        </div>
    </div>

    <!-- Tutor Session View -->
    <div id="sessionView" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Syllabus Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-4">
                    <h3 class="text-lg font-bold text-cozy-brown mb-4">üìã Learning Path</h3>
                    <div id="syllabusList" class="space-y-2">
                        <!-- Syllabus items will be loaded here -->
                    </div>
                    <button onclick="backToCreate()" 
                            class="mt-4 w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        ‚Üê New Topic
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div id="chatArea" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                        <!-- Chat messages will appear here -->
                    </div>

                    <!-- Answer Input -->
                    <div id="answerSection" class="hidden">
                        <div class="bg-warm-beige rounded-lg p-4 mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Answer:</label>
                            <textarea id="answerInput"
                                     rows="3"
                                     placeholder="Type your answer here..."
                                     class="w-full px-4 py-3 border-2 border-warm-yellow rounded-lg focus:outline-none focus:ring-2 focus:ring-caramel"></textarea>
                            <button onclick="submitAnswer()" 
                                    class="mt-2 bg-caramel text-white px-6 py-2 rounded-lg hover:bg-cozy-brown transition-colors">
                                Submit Answer
                            </button>
                        </div>
                    </div>

                    <!-- Next Step Button -->
                    <button id="nextStepBtn" 
                            onclick="teachNextStep()" 
                            class="w-full bg-caramel text-white px-6 py-3 rounded-lg hover:bg-cozy-brown transition-colors font-bold">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSessionId = null;
    let currentSession = null;

    async function createSession() {
        const topic = document.getElementById('topicInput').value.trim();
        
        if (!topic) {
            alert('Please enter a topic!');
            return;
        }

        try {
            const response = await fetch('/api/tutor/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic })
            });

            const data = await response.json();

            if (data.success) {
                currentSessionId = data.session_id;
                currentSession = data.session;
                loadSession();
            } else {
                alert('Error creating session: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to create session. Please try again.');
        }
    }

    function loadSession() {
        document.getElementById('createForm').classList.add('hidden');
        document.getElementById('sessionView').classList.remove('hidden');

        // Display syllabus
        const syllabusList = document.getElementById('syllabusList');
        syllabusList.innerHTML = currentSession.syllabus.map((step, index) => `
            <div class="flex items-center gap-2 p-2 rounded ${index === currentSession.current_step ? 'bg-warm-yellow font-bold' : 'bg-gray-100'}">
                <span class="${currentSession.completed_steps.includes(index) ? 'text-green-600' : 'text-gray-400'}">
                    ${currentSession.completed_steps.includes(index) ? '‚úì' : '‚óã'}
                </span>
                <span class="text-sm">${index + 1}. ${step}</span>
            </div>
        `).join('');

        // Start teaching first step
        teachNextStep();
    }

    async function teachNextStep() {
        if (!currentSessionId) return;

        try {
            const response = await fetch(`/api/tutor/${currentSessionId}/teach`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                const content = data.content;
                
                if (content.completed) {
                    addChatMessage('tutor', content.message);
                    document.getElementById('nextStepBtn').disabled = true;
                    return;
                }

                // Display teaching content
                addChatMessage('tutor', `
                    <div class="mb-4">
                        <h3 class="font-bold text-lg mb-2">Step ${content.step}/${content.total_steps}: ${content.title}</h3>
                        <p class="mb-4">${content.explanation}</p>
                        ${content.example ? `<div class="bg-warm-beige p-3 rounded-lg mb-4">
                            <strong>Example:</strong><br>${content.example}
                        </div>` : ''}
                        <div class="bg-caramel/10 p-3 rounded-lg">
                            <strong>Drill Question:</strong><br>${content.question}
                        </div>
                    </div>
                `);

                // Show answer input
                document.getElementById('answerSection').classList.remove('hidden');
                document.getElementById('nextStepBtn').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitAnswer() {
        const answer = document.getElementById('answerInput').value.trim();
        
        if (!answer) {
            alert('Please enter an answer!');
            return;
        }

        addChatMessage('student', answer);

        try {
            const response = await fetch(`/api/tutor/${currentSessionId}/answer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answer })
            });

            const data = await response.json();

            if (data.success) {
                const result = data.result;
                const feedback = result.correct 
                    ? `‚úÖ Correct! ${result.feedback}` 
                    : `‚ùå Not quite. ${result.feedback}`;
                
                addChatMessage('tutor', feedback);

                // Clear input
                document.getElementById('answerInput').value = '';
                document.getElementById('answerSection').classList.add('hidden');
                
                // Update current step
                currentSession.current_step = result.next_step;
                if (result.correct) {
                    currentSession.completed_steps.push(result.next_step - 1);
                }
                
                // Show next step button
                document.getElementById('nextStepBtn').classList.remove('hidden');
                
                // Reload session to update syllabus
                loadSessionSilent();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadSessionSilent() {
        try {
            const response = await fetch(`/api/tutor/${currentSessionId}`);
            const data = await response.json();
            if (data.success) {
                currentSession = data.session;
                // Update syllabus only
                const syllabusList = document.getElementById('syllabusList');
                syllabusList.innerHTML = currentSession.syllabus.map((step, index) => `
                    <div class="flex items-center gap-2 p-2 rounded ${index === currentSession.current_step ? 'bg-warm-yellow font-bold' : 'bg-gray-100'}">
                        <span class="${currentSession.completed_steps.includes(index) ? 'text-green-600' : 'text-gray-400'}">
                            ${currentSession.completed_steps.includes(index) ? '‚úì' : '‚óã'}
                        </span>
                        <span class="text-sm">${index + 1}. ${step}</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function addChatMessage(role, message) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = role === 'tutor' 
            ? 'bg-warm-beige rounded-lg p-4' 
            : 'bg-caramel/20 rounded-lg p-4 text-right';
        messageDiv.innerHTML = `
            <div class="text-sm font-bold mb-1">${role === 'tutor' ? 'ü¶´ Avner' : 'You'}</div>
            <div>${message}</div>
        `;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function backToCreate() {
        currentSessionId = null;
        currentSession = null;
        document.getElementById('createForm').classList.remove('hidden');
        document.getElementById('sessionView').classList.add('hidden');
        document.getElementById('topicInput').value = '';
        document.getElementById('chatArea').innerHTML = '';
    }
</script>
{% endblock %}
