{% extends "base.html" %}

{% block title %}×¡×™×›×•× ×—×›× - StudyBuddyAI{% endblock %}

{% block content %}
<div class="space-y-8 text-right">
    {% if course %}
    <!-- Course Context Header -->
    <div class="mb-6">
        <nav class="text-sm text-cozy-brown mb-2">
            <a href="{{ url_for('library.index') }}" class="hover:text-golden-yellow transition-colors">ğŸ“š ×”×¡×¤×¨×™×™×”</a>
            <span class="mx-2">/</span>
            <a href="{{ url_for('library.course_page', course_id=course.id) }}" class="hover:text-golden-yellow transition-colors">{{ course.icon }} {{ course.name }}</a>
            <span class="mx-2">/</span>
            <span class="text-dark-brown">×¡×™×›×•× ×—×›×</span>
        </nav>
    </div>
    {% endif %}
    
    <!-- Header with Avner -->
    <div class="flex items-start gap-4">
        <img src="{{ url_for('serve_avner', filename='avner_reading.jpeg') }}" 
             alt="××‘× ×¨ ×§×•×¨×" 
             class="w-20 h-20 rounded-full object-cover border-4 border-golden-yellow shadow-warm flex-shrink-0">
        <div>
            <h1 class="text-3xl font-bold text-dark-brown">ğŸ“– ×¡×™×›×•× ×—×›×</h1>
            {% if course %}
            <p class="text-cozy-brown mt-1 text-lg">×™×¦×™×¨×ª ×¡×™×›×•× ××”×—×•××¨×™× ×©×œ ×§×•×¨×¡ {{ course.name }}</p>
            {% else %}
            <p class="text-cozy-brown mt-1 text-lg">×”×¢×œ×• ×§×•×‘×¥ ××• ×”×“×‘×™×§×• ×˜×§×¡×˜, ×•×× ×™ ××¢×–×•×¨ ×œ×›× ×œ×”×‘×™×Ÿ ××•×ª×• ×˜×•×‘ ×™×•×ª×¨!</p>
            {% endif %}
        </div>
    </div>
    
    {% if course and context %}
    <!-- Course Mode: Direct Summary Generation -->
    <div class="content-card border-2 border-golden-yellow">
        <div class="flex items-center gap-4 mb-4">
            <img src="{{ url_for('serve_avner', filename='avner_signing_ok.jpeg') }}" 
                 alt="××‘× ×¨ ×××•×©×¨" 
                 class="w-16 h-16 rounded-full object-cover border-4 border-golden-yellow shadow-warm">
            <div>
                <h2 class="text-xl font-bold text-dark-brown">âœ… ××•×›×Ÿ!</h2>
                <p class="text-cozy-brown">××©×ª××© ×‘-{{ documents|length }} ××¡××›×™× ××”×§×•×¨×¡</p>
            </div>
        </div>
        <button hx-post="{{ url_for('summary_bp.trigger_summary') }}"
                hx-vals='{"text": {{ context|tojson }}, "course_id": "{{ course.id }}"}'
                hx-target="#task-status-container"
                hx-swap="innerHTML"
                class="btn-primary w-full text-lg shadow-warm">
            âœ¨ ×”×¤×§×ª ×¡×™×›×•×
        </button>
    </div>
    <div id="task-status-container" class="content-card min-h-[12rem]">
        <div class="flex flex-col items-center justify-center text-center text-cozy-brown h-full py-8">
            <p class="text-lg font-medium">×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××¢×œ×” ×›×“×™ ×œ×™×¦×•×¨ ×¡×™×›×•×</p>
        </div>
    </div>
    
    {% else %}
    <!-- Standalone Mode: Upload Required -->
    <div class="content-card border-2 border-golden-yellow">
        <div class="flex items-start gap-4 mb-6">
            <img src="{{ url_for('serve_avner', filename='avner_signing_ok.jpeg') }}" 
                 alt="××‘× ×¨ ×× ×•×¤×£" 
                 class="w-16 h-16 rounded-full object-cover border-4 border-warm-yellow shadow-md">
            <div>
                <h2 class="text-xl font-bold text-dark-brown">ğŸš€ ×‘×•× × ×ª×—×™×œ!</h2>
                <p class="text-cozy-brown mt-1">×”×¢×œ×” ××ª ×”×—×•××¨ ×©×œ×š ×•×× ×™ ××›×™×Ÿ ×œ×š ×¡×™×›×•× ××§×™×£</p>
            </div>
        </div>
        
        <div class="mt-6">
            <form id="upload-form"
                  hx-post="{{ url_for('upload_bp.upload_route') }}" 
                  hx-encoding="multipart/form-data"
                  hx-target="#upload-result"
                  hx-swap="innerHTML"
                  class="space-y-5">
                
                <input type="hidden" name="course_id" value="default">
                
                <div>
                    <label for="text" class="block text-sm font-bold text-dark-brown mb-2 text-right">
                        ğŸ“ ×”×“×‘×§ ×˜×§×¡×˜:
                    </label>
                    <textarea name="text" 
                              id="text"
                              class="form-input mobile-scroll" 
                              rows="8"
                              style="font-size: 16px;"
                              placeholder="×”×“×‘×™×§×• ×›××Ÿ ××ª ×”×—×•××¨ ×œ×¡×™×›×•×..."></textarea>
                </div>
                
                <div class="text-center text-warm-gray font-medium relative py-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t-2 border-warm-gray"></div>
                    </div>
                    <div class="relative flex justify-center">
                        <span class="px-4 bg-white">××•</span>
                    </div>
                </div>
                
                <div>
                    <label for="file" class="block text-sm font-bold text-dark-brown mb-2 text-right">
                        ğŸ“ ×”×¢×œ×” ×§×•×‘×¥:
                    </label>
                    <input type="file" 
                           name="file" 
                           id="file"
                           style="font-size: 16px;"
                           class="block w-full text-sm text-dark-brown file:ml-4 file:py-3 file:px-5 file:rounded-full file:border-0 file:font-bold file:bg-golden-yellow file:text-dark-brown hover:file:bg-warm-yellow file:shadow-md file:transition-all cursor-pointer"/>
                </div>

                <button type="submit" class="btn-primary w-full text-lg shadow-warm mobile-touch-target">
                    ğŸ” ×”×¢×œ××” ×•×¢×™×‘×•×“
                </button>
            </form>
            <div id="upload-result" class="mt-4 text-center">
                <!-- Upload status appears here -->
            </div>
        </div>
    </div>

    <!-- Action/Result Card -->
    <div id="action-container" class="content-card min-h-[12rem]">
        <div id="summary-controls" class="hidden">
            <!-- This section is now populated by the result of the file processing task -->
        </div>
        
        <div id="action-placeholder" class="flex flex-col items-center justify-center text-center text-cozy-brown h-full py-8">
            <img src="{{ url_for('serve_avner', filename='avner_thinking.jpeg') }}" 
                 alt="××‘× ×¨ ×××ª×™×Ÿ" 
                 class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-warm-beige shadow-soft">
            <p class="text-lg font-medium">ğŸ“¤ ×”×¢×œ×• ×§×•×‘×¥ ××• ×˜×§×¡×˜ ×›×“×™ ×œ×”×ª×—×™×œ</p>
            <p class="text-sm mt-2">×× ×™ ×××ª×™×Ÿ ×œ×—×•××¨ ×©×œ×›×...</p>
        </div>
        
        <div id="task-status-container" class="mt-4">
            <!-- Task polling status for summarization will appear here -->
        </div>
    </div>
    {% endif %}
</div>

<script>
document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    // This event listener handles the response from the upload form
    if (evt.target.id === 'upload-form') {
        const response = JSON.parse(evt.detail.xhr.responseText);
        
        if (response.status === 'processing' && response.polling_url) {
            // If the file is processing, start polling the task status
            const uploadResultDiv = document.getElementById('upload-result');
            uploadResultDiv.setAttribute('hx-get', response.polling_url);
            uploadResultDiv.setAttribute('hx-trigger', 'load, every 2s');
            uploadResultDiv.setAttribute('hx-swap', 'innerHTML');
            htmx.process(uploadResultDiv);
        } else if (response.status === 'completed' && response.document_id) {
            // If text was processed synchronously, show the generate button
            const actionContainer = document.getElementById('action-container');
            // We can create a new template for this or just inject the HTML
            actionContainer.innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <img src="{{ url_for('serve_avner', filename='avner_signing_ok.jpeg') }}" 
                         alt="××‘× ×¨ ×××•×©×¨" 
                         class="w-16 h-16 rounded-full object-cover border-4 border-golden-yellow shadow-warm">
                    <div>
                        <h2 class="text-xl font-bold text-dark-brown">âœ… ××•×›× ×™×!</h2>
                        <p class="text-cozy-brown">×”××¡××š <strong>${response.filename}</strong> ××•×›×Ÿ. ×‘×•××• × ×™×¦×•×¨ ×œ×• ×¡×™×›×•×!</p>
                    </div>
                </div>
                <button hx-post="{{ url_for('summary_bp.trigger_summary') }}"
                        hx-vals='{"document_id": "${response.document_id}"}'
                        hx-target="#task-status-container"
                        hx-swap="innerHTML"
                        class="btn-primary w-full text-lg shadow-warm">
                    âœ¨ ×”×¤×§×ª ×¡×™×›×•×
                </button>
            `;
            htmx.process(actionContainer);
        }
    }
});
</script>
{% endblock %}
