{% extends "base.html" %}

{% block title %}סיכום חכם - StudyBuddyAI{% endblock %}

{% block content %}
<div class="space-y-8 text-right">
    <!-- Input Card -->
    <div class="bg-white/80 p-6 rounded-2xl shadow-md">
        <div class="flex items-start space-x-4 space-x-reverse">
            <img src="{{ url_for('serve_avner', filename='avner_waving.jpeg') }}" alt="אבנר מנופף לשלום" class="h-16 w-16 flex-shrink-0">
            <div>
                <h2 class="text-xl font-bold text-warm-brown">סיכום חכם</h2>
                <p class="text-ink-brown/80 mt-1">העלו קובץ או הדביקו טקסט, ואני אעזור לכם להבין אותו טוב יותר.</p>
            </div>
        </div>
        
        <div class="mt-6">
            <form id="upload-form"
                  hx-post="{{ url_for('upload_bp.upload_route') }}" 
                  hx-encoding="multipart/form-data"
                  hx-target="#upload-result"
                  hx-swap="innerHTML">
                
                <input type="hidden" name="course_id" value="default">
                
                <textarea name="text" class="w-full p-3 border rounded-lg text-right" rows="8" placeholder="הדביקו כאן את החומר לסיכום..."></textarea>
                
                <div class="my-4 text-center text-gray-500">או</div>
                
                <input type="file" name="file" class="block w-full text-sm text-ink-brown file:ml-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-orange-100 file:text-capy-orange hover:file:bg-orange-200"/>

                <button type="submit" class="mt-6 w-full bg-capy-orange text-white font-bold py-3 px-5 rounded-lg shadow-sm hover:bg-opacity-90">
                    העלאה ועיבוד
                </button>
            </form>
            <div id="upload-result" class="mt-4 text-center">
                <!-- Upload status appears here -->
            </div>
        </div>
    </div>

    <!-- Action/Result Card -->
    <div id="action-container" class="bg-white/80 p-6 rounded-2xl shadow-md min-h-[10rem]">
        <div id="summary-controls" class="hidden">
            <!-- This section is now populated by the result of the file processing task -->
        </div>
        
        <div id="action-placeholder" class="flex flex-col items-center justify-center text-center text-ink-brown/60 h-full">
            <img src="{{ url_for('serve_avner', filename='avner_reading.jpeg') }}" alt="אבנר קורא ספר" class="h-24 mb-4">
            <p>העלו קובץ או טקסט כדי להתחיל.</p>
        </div>
        
        <div id="task-status-container" class="mt-4">
            <!-- Task polling status for summarization will appear here -->
        </div>
    </div>
</div>

<script>
document.body.addEventListener('htmx:afterOnLoad', function(evt) {
    // This event listener handles the response from the upload form
    if (evt.target.id === 'upload-form') {
        const response = JSON.parse(evt.detail.xhr.responseText);
        
        if (response.status === 'processing' && response.polling_url) {
            // If the file is processing, start polling the task status
            const uploadResultDiv = document.getElementById('upload-result');
            uploadResultDiv.setAttribute('hx-get', response.polling_url);
            uploadResultDiv.setAttribute('hx-trigger', 'load, every 2s');
            uploadResultDiv.setAttribute('hx-swap', 'innerHTML');
            htmx.process(uploadResultDiv);
        } else if (response.status === 'completed' && response.document_id) {
            // If text was processed synchronously, show the generate button
            const actionContainer = document.getElementById('action-container');
            // We can create a new template for this or just inject the HTML
            actionContainer.innerHTML = `
                <div class="flex items-center space-x-4 space-x-reverse mb-4">
                    <img src="{{ url_for('serve_avner', filename='avner_reading.jpeg') }}" alt="אבנר עם מחברת" class="h-16 w-16 flex-shrink-0">
                    <div>
                        <h2 class="text-xl font-bold text-warm-brown">מוכנים!</h2>
                        <p class="text-ink-brown/80">המסמך <strong>${response.filename}</strong> מוכן. בואו ניצור לו סיכום!</p>
                    </div>
                </div>
                <button hx-post="{{ url_for('summary_bp.trigger_summary') }}"
                        hx-vals='{"document_id": "${response.document_id}"}'
                        hx-target="#task-status-container"
                        hx-swap="innerHTML"
                        class="w-full bg-green-600 text-white font-bold py-3 px-5 rounded-lg shadow-sm hover:bg-green-700">
                    ✨ הפקת סיכום
                </button>
            `;
            htmx.process(actionContainer);
        }
    }
});
</script>
{% endblock %}
