{% extends "base.html" %}

{% block title %}××¡×›× - StudyBuddyAI{% endblock %}

{% block content %}
<!-- Header with Avner Avatar -->
<div class="mb-6">
    <nav class="text-sm text-cozy-brown mb-2">
        <a href="{{ url_for('index') }}" class="hover:text-golden-yellow transition-colors">×‘×™×ª</a>
        <span class="mx-2">/</span>
        <span class="text-dark-brown">××¡×›×</span>
    </nav>
    
    <div class="flex items-center gap-4">
        <div id="tool-avner" class="avner-tool-avatar"></div>
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-dark-brown">××¡×›× ×—×•××¨ ×œ×™××•×“</h1>
            <p class="text-cozy-brown text-sm mt-1">××‘× ×¨ ×™×¡×›× ×œ×š ××ª ×”×—×•××¨ ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×•×§×¦×¨×”</p>
        </div>
    </div>
</div>

<!-- What to Upload - Clear Instructions -->
<div class="bg-warm-yellow/30 border-2 border-golden-yellow rounded-2xl p-4 mb-6">
    <h3 class="font-bold text-dark-brown mb-2 flex items-center gap-2">
        <span>ğŸ“š</span> ××” ×œ×”×¢×œ×•×ª?
    </h3>
    <ul class="text-sm text-coffee space-y-1 list-disc list-inside">
        <li><strong>×¡×™×›×•××™×</strong> - ×¡×™×›×•××™ ×©×™×¢×•×¨×™×, ×”×¨×¦××•×ª, ×¤×¨×§×™× ××¡×¤×¨</li>
        <li><strong>××¦×’×•×ª</strong> - ×©×§×¤×™× ××”×§×•×¨×¡ (PDF)</li>
        <li><strong>××××¨×™×</strong> - ×˜×§×¡×˜×™× ××§×“××™×™× ××• ××§×¦×•×¢×™×™×</li>
        <li><strong>×”×¢×¨×•×ª</strong> - ×¨×©×™××•×ª ×•× ×§×•×“×•×ª ×©×¨×©××ª</li>
    </ul>
    <p class="text-xs text-cozy-brown mt-2">ğŸ’¡ ×˜×™×¤: ×›×›×œ ×©×”×—×•××¨ ×™×•×ª×¨ ×××•×§×“, ×”×¡×™×›×•× ×™×”×™×” ×™×•×ª×¨ ××“×•×™×§!</p>
</div>

<!-- Two-pane Layout -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Right Pane: Input Area -->
    <div class="bg-cream rounded-2xl p-6 shadow-md border border-warm-yellow">
        <h2 class="text-xl font-bold text-dark-brown mb-4">ğŸ“ ×”×–× ×ª ×”×—×•××¨</h2>
        
        <form id="summarize-form">
            <!-- Text Area -->
            <div class="mb-6">
                <label for="text-input" class="block text-sm font-medium text-dark-brown mb-2">
                    ×”×“×‘×§ ×˜×§×¡×˜ ××”×—×•××¨ ×©×œ×š:
                </label>
                <textarea 
                    id="text-input" 
                    name="text"
                    rows="8"
                    class="w-full p-4 border-2 border-warm-gray rounded-xl focus:ring-2 focus:ring-golden-yellow focus:border-golden-yellow transition-all resize-none bg-warm-beige"
                    placeholder="×”×¢×ª×§ ×•×”×“×‘×§ ×›××Ÿ ××ª ×”×˜×§×¡×˜ ×©×‘×¨×¦×•× ×š ×œ×¡×›×...

×œ×“×•×’××”:
- ×¤×¨×§ ××¡×¤×¨ ×œ×™××•×“
- ×¡×™×›×•× ×”×¨×¦××”
- ××××¨ ××• ×›×ª×‘×”
- ×¨×©×™××ª × ×§×•×“×•×ª ×—×©×•×‘×•×ª"></textarea>
            </div>
            
            <!-- OR Divider -->
            <div class="flex items-center gap-4 mb-6">
                <div class="flex-1 border-t border-warm-gray"></div>
                <span class="text-cozy-brown text-sm font-medium">××•</span>
                <div class="flex-1 border-t border-warm-gray"></div>
            </div>
            
            <!-- File Upload -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-dark-brown mb-2">
                    ×”×¢×œ×” ×§×•×‘×¥:
                </label>
                <div class="border-2 border-dashed border-warm-gray rounded-xl p-6 hover:border-golden-yellow transition-colors bg-warm-beige text-center">
                    <input 
                        type="file" 
                        id="file-input"
                        name="file"
                        accept=".pdf,.doc,.docx,.txt,.pptx"
                        class="hidden"
                        onchange="handleFileSelect(this, 'file-display')">
                    <label for="file-input" class="cursor-pointer">
                        <div class="text-4xl mb-2">ğŸ“„</div>
                        <p class="text-dark-brown font-medium">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥</p>
                        <p class="text-xs text-cozy-brown mt-1">PDF, Word, PowerPoint ××• ×˜×§×¡×˜ (×¢×“ 10MB)</p>
                    </label>
                </div>
                <div id="file-display" class="hidden mt-3 flex items-center gap-2 bg-warm-yellow text-dark-brown text-sm px-4 py-2 rounded-lg">
                    <span>âœ“</span>
                    <span id="file-name"></span>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden mb-4 p-3 bg-red-50 border-2 border-error rounded-lg text-error text-sm">
            </div>
            
            <!-- Submit Button -->
            <button 
                type="submit"
                id="submit-btn"
                class="w-full bg-golden-yellow text-dark-brown font-bold py-4 px-6 rounded-xl btn-hover-lift transition-all duration-150 flex items-center justify-center gap-2 shadow-md text-lg">
                <span>ğŸ¦« ×‘×§×© ×××‘× ×¨ ×œ×¡×›×</span>
            </button>
            
            <p class="text-xs text-center text-cozy-brown mt-3">
                ×”×¡×™×›×•× ×™×•×¤×™×¢ ×‘×¦×“ ×©×××œ ×ª×•×š ××¡×¤×¨ ×©× ×™×•×ª
            </p>
        </form>
    </div>
    
    <!-- Left Pane: Results Area -->
    <div class="bg-cream rounded-2xl p-6 shadow-md border border-warm-yellow">
        <h2 class="text-xl font-bold text-dark-brown mb-4">ğŸ“‹ ×”×¡×™×›×•× ×©×œ×š</h2>
        
        <div id="results-container">
            <!-- Empty State with Avner -->
            <div id="empty-state" class="text-center py-8">
                <div id="waiting-avner" class="mb-4"></div>
                <p class="text-cozy-brown leading-relaxed">
                    <strong>××‘× ×¨ ××—×›×” ×œ×—×•××¨ ×©×œ×š!</strong><br>
                    <span class="text-sm">×”×–×Ÿ ×˜×§×¡×˜ ××• ×”×¢×œ×” ×§×•×‘×¥ ××©×××œ, ×•××‘× ×¨ ×™×›×™×Ÿ ×œ×š ×¡×™×›×•× ××¡×•×“×¨.</span>
                </p>
            </div>
            
            <!-- Loading State -->
            <div id="loading-state" class="hidden text-center py-8">
                <div id="thinking-avner" class="mb-4"></div>
                <p class="text-cozy-brown">××‘× ×¨ ×§×•×¨× ××ª ×”×—×•××¨ ×•×›×•×ª×‘ ×¡×™×›×•×...</p>
                <div class="mt-4 flex justify-center">
                    <div class="avner-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
            
            <!-- Summary Result -->
            <div id="summary-result" class="hidden">
                <div class="prose prose-brown max-w-none" id="summary-content">
                    <!-- Summary will be inserted here -->
                </div>
                
                <!-- Success Avner -->
                <div class="mt-6 flex items-center gap-3 p-4 bg-green-50 rounded-xl border border-success">
                    <div id="success-avner"></div>
                    <p class="text-dark-brown text-sm">×”×¡×™×›×•× ××•×›×Ÿ! ×™×© ×œ×š ×©××œ×•×ª ×¢×œ ×”×—×•××¨?</p>
                </div>
            </div>
        </div>
        
        <div id="task-status-container" class="mt-4"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Avner avatars
    document.addEventListener('DOMContentLoaded', function() {
        // Tool header avatar
        new AvnerAvatar('tool-avner', { size: 'medium', showBubble: false });
        
        // Waiting avatar
        new AvnerAvatar('waiting-avner', { size: 'large', showBubble: true });
    });
    
    // File selection handler
    function handleFileSelect(input, displayId) {
        const display = document.getElementById(displayId);
        const fileName = document.getElementById('file-name');
        if (input.files && input.files.length > 0) {
            const file = input.files[0];
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            fileName.textContent = `${file.name} (${sizeMB}MB)`;
            display.classList.remove('hidden');
        } else {
            display.classList.add('hidden');
        }
    }
    
    // Form submission
    document.getElementById('summarize-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const textInput = document.getElementById('text-input').value.trim();
        const fileInput = document.getElementById('file-input').files[0];
        const errorDiv = document.getElementById('error-message');
        
        // Validation
        if (!textInput && !fileInput) {
            errorDiv.textContent = 'âš ï¸ ×”×–×Ÿ ×˜×§×¡×˜ ××• ×”×¢×œ×” ×§×•×‘×¥ ×›×“×™ ×œ×”××©×™×š';
            errorDiv.classList.remove('hidden');
            return;
        }
        
        errorDiv.classList.add('hidden');
        
        // Show loading state
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('summary-result').classList.add('hidden');
        
        // Initialize thinking avatar
        if (!document.getElementById('thinking-avner').hasChildNodes()) {
            const thinkingAvner = new AvnerAvatar('thinking-avner', { size: 'large', showBubble: true });
            thinkingAvner.setState('thinking');
        }
        
        try {
            let docId;
            
            if (fileInput) {
                // Upload file
                const formData = new FormData();
                formData.append('file', fileInput);
                
                const uploadRes = await fetch('/api/upload/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadRes.ok) throw new Error('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
                const uploadData = await uploadRes.json();
                docId = uploadData.document_id;
            } else {
                // Create document from text
                const formData = new FormData();
                const blob = new Blob([textInput], { type: 'text/plain' });
                formData.append('file', blob, 'text_input.txt');
                
                const uploadRes = await fetch('/api/upload/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadRes.ok) throw new Error('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×§×¡×˜');
                const uploadData = await uploadRes.json();
                docId = uploadData.document_id;
            }
            
            // Trigger summary
            const summaryRes = await fetch('/api/summary/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ document_id: docId })
            });
            
            if (!summaryRes.ok) throw new Error('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×›×•×');
            const summaryData = await summaryRes.json();
            
            // Poll for results
            pollTaskStatus(summaryData.task_id);
            
        } catch (error) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            errorDiv.textContent = 'âŒ ' + error.message;
            errorDiv.classList.remove('hidden');
        }
    });
    
    async function pollTaskStatus(taskId) {
        const pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`/api/tasks/${taskId}`);
                const data = await res.json();
                
                if (data.status === 'COMPLETED') {
                    clearInterval(pollInterval);
                    showResults(data.result_id);
                } else if (data.status === 'FAILED') {
                    clearInterval(pollInterval);
                    showError(data.error_message || '××©×”×• ×”×©×ª×‘×©, × ×¡×” ×©×•×‘');
                }
            } catch (error) {
                clearInterval(pollInterval);
                showError('×©×’×™××” ×‘×‘×“×™×§×ª ×”×¡×˜×˜×•×¡');
            }
        }, 2000);
    }
    
    async function showResults(resultId) {
        try {
            const res = await fetch(`/results/summary/${resultId}`);
            const html = await res.text();
            
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('summary-result').classList.remove('hidden');
            document.getElementById('summary-content').innerHTML = html;
            
            // Initialize success avatar
            if (!document.getElementById('success-avner').hasChildNodes()) {
                const successAvner = new AvnerAvatar('success-avner', { size: 'small', showBubble: false });
                successAvner.setState('success');
            }
        } catch (error) {
            showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×•×¦××•×ª');
        }
    }
    
    function showError(message) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'âŒ ' + message;
        errorDiv.classList.remove('hidden');
    }
</script>
{% endblock %}
