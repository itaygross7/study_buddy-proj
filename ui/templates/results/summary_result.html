<!-- templates/summary/_summary_detail.html -->
<div class="prose max-w-none">
    <h3 class="text-lg font-bold text-dark-brown mb-4">住</h3>
    <div class="bg-warm-beige p-4 rounded-xl border border-warm-yellow">
        <p class="text-dark-brown leading-relaxed whitespace-pre-wrap">{{ summary.summary_text }}</p>
    </div>

    <!-- Interactive Q&A Section -->
    <div class="mt-6 bg-cream p-6 rounded-xl border-2 border-golden-yellow">
        <div class="flex items-center gap-3 mb-4">
            <img src="{{ url_for('serve_avner', filename='avner_signing_ok.jpeg') }}"
                 alt="专"
                 class="w-12 h-12 rounded-full object-cover border-2 border-golden-yellow">
            <div>
                <h4 class="font-bold text-dark-brown">砖  砖转 注 住?</h4>
                <p class="text-sm text-cozy-brown">  注专 专! Λ</p>
            </div>
        </div>

        <div id="summary-chat-{{ summary._id }}" class="space-y-3 mb-4 max-h-96 overflow-y-auto">
            <!-- Chat messages will appear here -->
        </div>

        <form id="summary-question-form-{{ summary._id }}" class="flex gap-2" onsubmit="askAboutSummary(event, '{{ summary._id }}'); return false;">
            <input type="text"
                   id="summary-question-{{ summary._id }}"
                   placeholder="砖: 转住专  转专 注..."
                   class="flex-grow p-3 border-2 border-warm-yellow rounded-lg text-right focus:ring-2 focus:ring-golden-yellow"
                   required>
            <button type="submit" class="bg-golden-yellow hover:bg-warm-yellow text-dark-brown font-bold px-6 py-3 rounded-lg transition-colors">
                砖 
            </button>
        </form>

        <p class="text-xs text-warm-gray mt-2 text-center">砖转 砖 注 注 住住 住 专 拽专</p>
    </div>

    <script>
        document.getElementById('empty-state')?.classList.add('hidden');
        document.getElementById('speech-bubble')?.classList.remove('hidden');

        async function askAboutSummary(event, summaryId) {
            event.preventDefault();

            const questionInput = document.getElementById('summary-question-' + summaryId);
            const question = questionInput.value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('summary-chat-' + summaryId);

            const userMsg = document.createElement('div');
            userMsg.className = 'bg-golden-yellow/20 p-3 rounded-lg border border-golden-yellow text-right';
            const userLabel = document.createElement('strong');
            userLabel.textContent = '转: ';
            userMsg.appendChild(userLabel);
            userMsg.appendChild(document.createTextNode(question));
            chatContainer.appendChild(userMsg);

            questionInput.value = '';

            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'bg-warm-beige p-3 rounded-lg border border-warm-yellow text-right';
            const loadingLabel = document.createElement('strong');
            loadingLabel.textContent = '专: ';
            const loadingSpan = document.createElement('span');
            loadingSpan.className = 'animate-pulse';
            loadingSpan.textContent = '砖...';
            loadingMsg.appendChild(loadingLabel);
            loadingMsg.appendChild(loadingSpan);
            loadingMsg.id = 'loading-' + summaryId;
            chatContainer.appendChild(loadingMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/api/avner/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question + '\n\n拽砖专: ' + `{{ summary.summary_text|escapejs }}`,
                        baby_mode: false
                    })
                });

                const data = await response.json();

                document.getElementById('loading-' + summaryId)?.remove();

                const avnerMsg = document.createElement('div');
                avnerMsg.className = 'bg-warm-beige p-3 rounded-lg border border-warm-yellow text-right';
                const avnerLabel = document.createElement('strong');
                avnerLabel.textContent = '专: ';
                avnerMsg.appendChild(avnerLabel);
                avnerMsg.appendChild(document.createTextNode(data.answer || data.error || '砖 拽转 转砖'));
                chatContainer.appendChild(avnerMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-' + summaryId)?.remove();

                const errorMsg = document.createElement('div');
                errorMsg.className = 'bg-red-100 p-3 rounded-lg border border-red-300 text-right';
                const errorLabel = document.createElement('strong');
                errorLabel.textContent = '砖: ';
                errorMsg.appendChild(errorLabel);
                errorMsg.appendChild(document.createTextNode(' 爪转 拽 转砖. 住 砖 Λ'));
                chatContainer.appendChild(errorMsg);
            }
        }
    </script>
</div>
