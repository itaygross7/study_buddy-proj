# StudyBuddyAI Caddy Configuration
# Automatic HTTPS with Let's Encrypt
#
# This configuration:
# - Automatically obtains and renews SSL certificates
# - Redirects HTTP to HTTPS
# - Adds security headers
# - Proxies requests to Flask app
#
# The domain is read from the DOMAIN environment variable
# Default: studybuddyai.my

{$DOMAIN:studybuddyai.my} {
    # Reverse proxy to Flask application
    reverse_proxy localhost:5000 {
        # Health checks
        health_uri /health
        health_interval 30s
        health_timeout 5s
        
        # Headers for proper proxying
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Enable gzip compression
    encode gzip
    
    # Security headers
    header {
        # Prevent MIME type sniffing
        X-Content-Type-Options nosniff
        
        # Prevent clickjacking
        X-Frame-Options DENY
        
        # XSS protection
        X-XSS-Protection "1; mode=block"
        
        # Referrer policy
        Referrer-Policy strict-origin-when-cross-origin
        
        # Content Security Policy (adjust as needed)
        # Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;"
        
        # Remove server header
        -Server
    }
    
    # Access logging
    log {
        output file /var/log/caddy/studybuddyai.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
    
    # Handle errors gracefully
    handle_errors {
        respond "{http.error.status_code} {http.error.status_text}"
    }
}

# Optional: Redirect HTTP to HTTPS (Caddy does this automatically)
# Optional: Handle additional subdomains if needed
